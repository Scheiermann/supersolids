<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>supersolids.SchroedingerMixture &mdash; supersolids 0.1.37rc1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> supersolids
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Supersolids</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CONTRIBUTING.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSE.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">supersolids</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">supersolids.SchroedingerMixture</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for supersolids.SchroedingerMixture</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># author: Daniel Scheiermann</span>
<span class="c1"># email: daniel.scheiermann@itp.uni-hannover.de</span>
<span class="c1"># license: MIT</span>
<span class="c1"># Please feel free to use and modify this, but keep the above information.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Numerical solver for non-linear time-dependent Schrodinger equation (eGPE) for dipolar mixtures.</span>


<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">import</span> <span class="nn">dill</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>
<span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">from</span> <span class="nn">scipy.integrate</span> <span class="kn">import</span> <span class="n">quad_vec</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">distance_transform_edt</span>

<span class="kn">from</span> <span class="nn">supersolids.helper</span> <span class="kn">import</span> <span class="n">constants</span><span class="p">,</span> <span class="n">functions</span><span class="p">,</span> <span class="n">get_path</span><span class="p">,</span> <span class="n">get_version</span>

<span class="n">__GPU_OFF_ENV__</span><span class="p">,</span> <span class="n">__GPU_INDEX_ENV__</span> <span class="o">=</span> <span class="n">get_version</span><span class="o">.</span><span class="n">get_env_variables</span><span class="p">()</span>
<span class="n">cp</span><span class="p">,</span> <span class="n">cupy_used</span><span class="p">,</span> <span class="n">cuda_used</span><span class="p">,</span> <span class="n">numba_used</span> <span class="o">=</span> <span class="n">get_version</span><span class="o">.</span><span class="n">check_cp_nb</span><span class="p">(</span><span class="n">np</span><span class="p">,</span>
                                                               <span class="n">gpu_off</span><span class="o">=</span><span class="n">__GPU_OFF_ENV__</span><span class="p">,</span>
                                                               <span class="n">gpu_index</span><span class="o">=</span><span class="n">__GPU_INDEX_ENV__</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">supersolids.helper.numbas</span> <span class="k">as</span> <span class="nn">numbas</span>

<span class="kn">from</span> <span class="nn">supersolids.Schroedinger</span> <span class="kn">import</span> <span class="n">Schroedinger</span>
<span class="kn">from</span> <span class="nn">supersolids.SchroedingerMixtureSummary</span> <span class="kn">import</span> <span class="n">SchroedingerMixtureSummary</span>
<span class="kn">from</span> <span class="nn">supersolids.helper</span> <span class="kn">import</span> <span class="n">constants</span><span class="p">,</span> <span class="n">functions</span>
<span class="kn">from</span> <span class="nn">supersolids.helper.Box</span> <span class="kn">import</span> <span class="n">Box</span>
<span class="kn">from</span> <span class="nn">supersolids.helper.Resolution</span> <span class="kn">import</span> <span class="n">Resolution</span>
<span class="kn">from</span> <span class="nn">supersolids.helper.run_time</span> <span class="kn">import</span> <span class="n">run_time</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">from sympy import diff, sqrt, re</span>
<span class="sd">from sympy import symbols</span>
<span class="sd">from sympy import lambdify</span>

<span class="sd">def eta_V_symb(lam, aa, bb, ab, a, b):</span>
<span class="sd">    return (aa * a + bb * b + lam * sqrt((aa * a - bb * b) ** 2.0 + 4.0 * ab ** 2.0 * a * b)) ** 2.5</span>


<span class="sd">def func_V_symb():</span>
<span class="sd">    lam, aa, bb, ab, a, b = symbols(&#39;lam aa bb ab a b&#39;)</span>
<span class="sd">    eta_V_symb_s = eta_V_symb(lam, aa, bb, ab, a, b)</span>
<span class="sd">    already_used = (2.0 / 5.0)</span>
<span class="sd">    v_a = already_used * diff(eta_V_symb_s, a)</span>
<span class="sd">    v_b = already_used * diff(eta_V_symb_s, b)</span>
<span class="sd">    v_a_sum = v_a.subs(lam, 1.0) + v_a.subs(lam, -1.0)</span>
<span class="sd">    v_b_sum = v_b.subs(lam, 1.0) + v_b.subs(lam, -1.0)</span>
<span class="sd">    symb = (aa, bb, ab, a, b)</span>
<span class="sd">    v_a_np = lambdify(symb, v_a_sum, modules=&#39;numpy&#39;)</span>
<span class="sd">    v_b_np = lambdify(symb, v_b_sum, modules=&#39;numpy&#39;)</span>

<span class="sd">    return [v_a_np, v_b_np]</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="smaller_slice"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.smaller_slice">[docs]</a><span class="k">def</span> <span class="nf">smaller_slice</span><span class="p">(</span><span class="n">val0</span><span class="p">,</span> <span class="n">val1</span><span class="p">):</span>
    <span class="c1"># decrease interval from left and right by one</span>

    <span class="c1"># make sure updated val1 will be bigger than updated val0</span>
    <span class="k">if</span> <span class="n">val0</span> <span class="o">&lt;</span> <span class="n">val1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">val0</span> <span class="o">=</span> <span class="n">val0</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">val1</span> <span class="o">=</span> <span class="n">val1</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">val0</span> <span class="o">==</span> <span class="n">val1</span><span class="p">:</span>
            <span class="n">val1</span> <span class="o">=</span> <span class="n">val1</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">changed</span><span class="p">,</span> <span class="n">val0</span><span class="p">,</span> <span class="n">val1</span></div>

<div class="viewcode-block" id="get_A_density_total"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.get_A_density_total">[docs]</a><span class="k">def</span> <span class="nf">get_A_density_total</span><span class="p">(</span><span class="n">density_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">density_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> 
            <span class="n">density_total</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">density_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">density</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">density_list</span><span class="p">):</span>
                    <span class="n">density_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">density</span><span class="p">)</span>
                <span class="n">density_total</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">density_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">density_total</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">density_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">density_total</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">density_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">density</span> <span class="ow">in</span> <span class="n">density_list</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="n">density_total</span> <span class="o">+=</span> <span class="n">density</span>

    <span class="c1"># A = n1/(n1+n2)</span>
    <span class="n">density_A</span> <span class="o">=</span> <span class="n">density_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">density_total</span>
    <span class="c1"># remove nan, because of possible 0/0 </span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">density_A</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">density_A</span> <span class="o">!=</span> <span class="n">cp</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">density_A</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">density_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">density_A</span> <span class="o">!=</span> <span class="n">cp</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">density_A</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">density_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">density_A</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">density_A</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">density_A</span><span class="p">,</span> <span class="n">density_total</span></div>


<div class="viewcode-block" id="get_mu_lhy_integrated_list"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.get_mu_lhy_integrated_list">[docs]</a><span class="k">def</span> <span class="nf">get_mu_lhy_integrated_list</span><span class="p">(</span><span class="n">func_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Callable</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
    <span class="n">mu_lhy_prefactor</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span>
    <span class="n">mu_lhy_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">func_list</span><span class="p">:</span>
        <span class="n">mu_lhy_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mu_lhy_prefactor</span> <span class="o">*</span> <span class="n">quad_vec</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">mu_lhy_list</span></div>


<div class="viewcode-block" id="SchroedingerMixture"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture">[docs]</a><span class="k">class</span> <span class="nc">SchroedingerMixture</span><span class="p">(</span><span class="n">Schroedinger</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements a numerical solution of the dimensionless time-dependent</span>
<span class="sd">    non-linear Schroedinger equation for an arbitrary potential:</span>

<span class="sd">    .. math::</span>

<span class="sd">       i \\partial_t \psi = [&amp;-\\frac{1}{2} \\nabla ^2</span>
<span class="sd">                              + \\frac{1}{2} (x^2 + (y \\alpha_y)^2 + (z \\alpha_z)^2) \\\\</span>
<span class="sd">                             &amp;+ g |\psi|^2  + g_{qf} |\psi|^3 + U_{dd}] \psi \\\\</span>

<span class="sd">    With :math:`U_{dd} = \\mathcal{F}^{-1}(\\mathcal{F}(H_{pot} \psi) \epsilon_{dd} g (3 (k_z / k)^2 - 1))`</span>

<span class="sd">    The split operator method with the Trotter-Suzuki approximation</span>
<span class="sd">    for the commutator relation (:math:`H = H_{pot} + H_{kin}`) is used.</span>
<span class="sd">    Hence the accuracy is proportional to :math:`dt^4`</span>
<span class="sd">    The approximation is needed because of the Baker-Campell-Hausdorff formula.</span>

<span class="sd">    m is the atomic mass</span>
<span class="sd">    :math:`C_{d d}=\mu_{0} \mu^{2}` sets the strength of the dipolar interaction</span>
<span class="sd">    with :math:`\mu=9.93 \mu_{\mathrm{B}}` the magnetic dipole moment of</span>
<span class="sd">    :math:`^{162}\mathrm{Dy}`.</span>

<span class="sd">    We use dipolar units, obtained from the characteristic dipolar length</span>
<span class="sd">    :math:`r_{0}= \\frac{m C_{d d}}{4 \pi \hbar^{2}}  = 387.672168  a_0`</span>
<span class="sd">    and the dipolar scale of energy :math:`\epsilon_{0} = \\frac{\hbar^{2}}{m r_{0}^{2}}`</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">MyBox</span><span class="p">:</span> <span class="n">Box</span><span class="p">,</span>
                 <span class="n">Res</span><span class="p">:</span> <span class="n">Resolution</span><span class="p">,</span>
                 <span class="n">max_timesteps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">N_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                 <span class="n">m_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                 <span class="n">a_s_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">a_dd_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                 <span class="n">t</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">a_s_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span>
                 <span class="n">a_dd_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
                 <span class="n">nA_max</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                 <span class="n">dt_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">w_x</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">33.0</span><span class="p">,</span>
                 <span class="n">w_y</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">80.0</span><span class="p">,</span>
                 <span class="n">w_z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">167.0</span><span class="p">,</span>
                 <span class="n">imag_time</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">tilt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">stack_shift</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">mu_arr</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">E</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">V</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">v_harmonic_3d</span><span class="p">,</span>
                 <span class="n">V_interaction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">psi_0_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">functions</span><span class="o">.</span><span class="n">psi_gauss_3d</span><span class="p">],</span>
                 <span class="n">psi_0_noise_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">functions</span><span class="o">.</span><span class="n">noise_mesh</span><span class="p">],</span>
                 <span class="n">psi_sol_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">functions</span><span class="o">.</span><span class="n">thomas_fermi_3d</span><span class="p">],</span>
                 <span class="n">mu_sol_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[</span><span class="n">functions</span><span class="o">.</span><span class="n">mu_3d</span><span class="p">],</span>
                 <span class="n">input_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;~/supersolids/results&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(),</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SchroedingerMixtureSummary_&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imag_time</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">imag_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_timesteps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">max_timesteps</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">nA_max</span> <span class="o">=</span> <span class="n">nA_max</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">check_ResBox</span><span class="p">(</span><span class="n">Res</span><span class="p">,</span> <span class="n">MyBox</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span><span class="o">.</span><span class="n">dim</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">N_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">N_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">m_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">m_list</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">a_s_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">a_s_factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_dd_factor</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">a_dd_factor</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">a_s_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">a_s_array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_dd_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">a_dd_array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_func</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w_x</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">w_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_y</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">w_y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">w_z</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">tilt</span> <span class="o">=</span> <span class="n">tilt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stack_shift</span> <span class="o">=</span> <span class="n">stack_shift</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">E</span>

        <span class="k">if</span> <span class="n">mu_arr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mu_arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_list</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mu_arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">mu_arr</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">psi_0_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi_0_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="n">psi_sol_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu_sol_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mu_sol_list</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol_val_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu_sol_val_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">input_path</span>

        <span class="k">if</span> <span class="n">V</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">V</span>

        <span class="k">if</span> <span class="n">V_interaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V_interaction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V_interaction</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">V_interaction</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        for mu_sol in self.mu_sol_list:</span>
<span class="sd">            if mu_sol is None:</span>
<span class="sd">                self.mu_sol_val_list.append(None)</span>
<span class="sd">            else:</span>
<span class="sd">                if callable(mu_sol):</span>
<span class="sd">                    self.mu_sol_val_list.append(mu_sol(self.g))</span>
<span class="sd">                else:</span>
<span class="sd">                    self.mu_sol_val_list.append(mu_sol)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkx</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">get_grid_helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ky</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dky</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">get_grid_helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkz</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">get_grid_helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># TODO: complete implementation</span>
            <span class="k">if</span> <span class="n">psi_0_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">psi_0</span><span class="p">,</span> <span class="n">psi_0_noise</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">psi_0_list</span><span class="p">,</span> <span class="n">psi_0_noise_list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
                        <span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">psi_0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">psi_0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">psi_0_noise</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psi_val</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psi_0_noise</span> <span class="o">*</span> <span class="n">psi_val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no initialization</span>
                <span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psi_val</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">k_squared</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kx</span> <span class="o">**</span> <span class="mf">2.0</span>

            <span class="k">if</span> <span class="n">V</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_val</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">V_interaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># For no interaction the identity is needed with respect to 2D</span>
                <span class="c1"># * 2D (array with 1.0 everywhere)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">V_interaction</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span> <span class="o">=</span> <span class="n">V_interaction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span> <span class="o">=</span> <span class="n">V_interaction</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="c1"># TODO: complete implementation</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">get_meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">psi_0_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">psi_0</span><span class="p">,</span> <span class="n">psi_0_noise</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">psi_0_list</span><span class="p">,</span> <span class="n">psi_0_noise_list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
                        <span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">psi_0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">psi_0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">psi_0_noise</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psi_val</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psi_0_noise</span> <span class="o">*</span> <span class="n">psi_val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no initialization</span>
                <span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psi_val</span><span class="p">)</span>


            <span class="n">kx_mesh</span><span class="p">,</span> <span class="n">ky_mesh</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">get_meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ky</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_squared</span> <span class="o">=</span> <span class="n">kx_mesh</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">ky_mesh</span> <span class="o">**</span> <span class="mf">2.0</span>

            <span class="k">if</span> <span class="n">V</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_val</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_mesh</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">get_grid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span><span class="p">)</span>
            <span class="c1"># if cupy_used:</span>
            <span class="c1">#     x_mesh, y_mesh, z_mesh = cp.asarray(x_mesh), cp.asarray(y_mesh), cp.asarray(z_mesh)</span>
            <span class="c1">#     x_mesh, y_mesh, z_mesh = self.x_mesh.get(), self.y_mesh.get(), self.z_mesh.get()</span>
     
            <span class="k">if</span> <span class="n">psi_0_list</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">psi_0</span><span class="p">,</span> <span class="n">psi_0_noise</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">psi_0_list</span><span class="p">,</span> <span class="n">psi_0_noise_list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
                        <span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">psi_0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_mesh</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">psi_0_noise</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psi_val</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># psi_0_noise: cp.ndarray = cp.asarray(psi_0_noise)</span>
                            <span class="c1"># psi_val_noisy = psi_0_noise * psi_val</span>
                            <span class="n">psi_val_noisy</span> <span class="o">=</span> <span class="n">psi_0_noise</span> <span class="o">*</span> <span class="n">psi_val</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">psi_val_noisy</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">psi_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">psi_0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_mesh</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">psi_0_noise</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psi_val</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">psi_val_noisy</span> <span class="o">=</span> <span class="n">psi_0_noise</span> <span class="o">*</span> <span class="n">psi_val</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psi_val_noisy</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># no initialization</span>
                <span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psi_val</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">psi_sol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">psi_sol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">psi_sol</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
                            <span class="n">psi_sol_val</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">psi_sol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_mesh</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">psi_sol_val</span> <span class="o">=</span> <span class="n">psi_sol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_mesh</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol_val_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">psi_sol_val</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">psi_sol_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Norm for psi_sol (trapez integral): &quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trapez_integral</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">psi_sol_val</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">kx_mesh</span><span class="p">,</span> <span class="n">ky_mesh</span><span class="p">,</span> <span class="n">kz_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ky</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kz</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_squared</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">kx_mesh</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">ky_mesh</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">kz_mesh</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kz_mesh</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">kz_mesh</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">kz_mesh</span> <span class="o">=</span> <span class="n">kz_mesh</span>

            <span class="k">if</span> <span class="n">V</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_val</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">,</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">y_mesh</span><span class="p">,</span>
                                                               <span class="bp">self</span><span class="o">.</span><span class="n">z_mesh</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_mesh</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_interaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># For no interaction the identity is needed with respect to 2D</span>
                <span class="c1"># * 2D (array with 1.0 everywhere)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_interaction</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_interaction</span><span class="p">(</span><span class="n">kx_mesh</span><span class="p">,</span> <span class="n">ky_mesh</span><span class="p">,</span> <span class="n">kz_mesh</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">imag_time</span><span class="p">:</span>
            <span class="c1"># Convention: $e^{-iH} = e^{UH}$</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">:</span> <span class="nb">complex</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="n">j</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">H_kin</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_squared</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nA_max</span><span class="p">)</span>

        <span class="n">eta_dVdna</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">numbas</span><span class="o">.</span><span class="n">eta_dVdna_jit</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>
        <span class="n">eta_dVdnb</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">numbas</span><span class="o">.</span><span class="n">eta_dVdnb_jit</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>
 
        <span class="n">mu_lhy_integrand_a</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu_lhy_integrand</span><span class="p">,</span> <span class="n">eta_dVdn</span><span class="o">=</span><span class="n">eta_dVdna</span><span class="p">)</span>
        <span class="n">mu_lhy_integrand_b</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu_lhy_integrand</span><span class="p">,</span> <span class="n">eta_dVdn</span><span class="o">=</span><span class="n">eta_dVdnb</span><span class="p">)</span>
        
        <span class="c1">######## testing</span>
        <span class="n">eta_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_s_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_s_array</span>
                                 <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_dd_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_dd_array</span> <span class="o">*</span> <span class="n">quad_vec</span><span class="p">(</span><span class="n">functions</span><span class="o">.</span><span class="n">dipol_dipol</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                 <span class="p">)</span>
        <span class="n">eta_aa</span> <span class="o">=</span> <span class="n">eta_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">eta_ab</span> <span class="o">=</span> <span class="n">eta_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">eta_bb</span> <span class="o">=</span> <span class="n">eta_array</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">c_t1</span> <span class="o">=</span> <span class="n">eta_dVdna</span><span class="p">(</span><span class="n">lam</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">eta_aa</span><span class="o">=</span><span class="n">eta_aa</span><span class="p">,</span> <span class="n">eta_bb</span><span class="o">=</span><span class="n">eta_bb</span><span class="p">,</span> <span class="n">eta_ab</span><span class="o">=</span><span class="n">eta_ab</span><span class="p">)</span>
        <span class="n">c_t2</span> <span class="o">=</span> <span class="n">eta_dVdna</span><span class="p">(</span><span class="n">lam</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">eta_aa</span><span class="o">=</span><span class="n">eta_aa</span><span class="p">,</span> <span class="n">eta_bb</span><span class="o">=</span><span class="n">eta_bb</span><span class="p">,</span> <span class="n">eta_ab</span><span class="o">=</span><span class="n">eta_ab</span><span class="p">)</span>
        <span class="n">d_t1</span> <span class="o">=</span> <span class="n">eta_dVdnb</span><span class="p">(</span><span class="n">lam</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">eta_aa</span><span class="o">=</span><span class="n">eta_aa</span><span class="p">,</span> <span class="n">eta_bb</span><span class="o">=</span><span class="n">eta_bb</span><span class="p">,</span> <span class="n">eta_ab</span><span class="o">=</span><span class="n">eta_ab</span><span class="p">)</span>
        <span class="n">d_t2</span> <span class="o">=</span> <span class="n">eta_dVdnb</span><span class="p">(</span><span class="n">lam</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">eta_aa</span><span class="o">=</span><span class="n">eta_aa</span><span class="p">,</span> <span class="n">eta_bb</span><span class="o">=</span><span class="n">eta_bb</span><span class="p">,</span> <span class="n">eta_ab</span><span class="o">=</span><span class="n">eta_ab</span><span class="p">)</span>
        <span class="n">b_t</span> <span class="o">=</span> <span class="n">quad_vec</span><span class="p">(</span><span class="n">mu_lhy_integrand_b</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">a_t</span> <span class="o">=</span> <span class="n">quad_vec</span><span class="p">(</span><span class="n">mu_lhy_integrand_a</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1">######## testing</span>

        <span class="n">mu_lhy_integrated_list</span> <span class="o">=</span> <span class="n">get_mu_lhy_integrated_list</span><span class="p">(</span><span class="n">func_list</span><span class="o">=</span><span class="p">[</span><span class="n">mu_lhy_integrand_a</span><span class="p">,</span>
                                                                       <span class="n">mu_lhy_integrand_b</span><span class="p">])</span>

        <span class="c1"># V_symb: List[Callable] = func_V_symb()</span>
        <span class="c1"># func_fa_symb = functools.partial(self.func_f_symb, func=V_symb[0],</span>
        <span class="c1">#                                  eta_a=self.A, eta_b=1.0 - self.A)</span>
        <span class="c1"># func_fb_symb = functools.partial(self.func_f_symb, func=V_symb[1],</span>
        <span class="c1">#                                  eta_a=self.A, eta_b=1.0 - self.A)</span>
        <span class="c1"># mu_v_list_symb = construct_mu_lhy_list(func_list=[func_fa_symb, func_fb_symb])</span>

        <span class="n">mu_lhy_interpolation_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mu_lhy_integrated</span> <span class="ow">in</span> <span class="n">mu_lhy_integrated_list</span><span class="p">:</span>
            <span class="n">mu_lhy_interpolation_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">mu_lhy_integrated</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mu_lhy_interpolation_list</span> <span class="o">=</span> <span class="n">mu_lhy_interpolation_list</span>

        <span class="n">energy_v</span> <span class="o">=</span> <span class="n">quad_vec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func_energy</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_helper_function</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">energy_v</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_squared</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_squared</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H_kin</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_kin</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">H_kin_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">m_list</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">H_kin_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_kin</span><span class="p">)</span>

<div class="viewcode-block" id="SchroedingerMixture.convert_all_to_numpy"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.convert_all_to_numpy">[docs]</a>    <span class="k">def</span> <span class="nf">convert_all_to_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_s_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_s_array</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_dd_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_dd_array</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">k_squared</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_squared</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">V_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_val</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">H_kin</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_kin</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H_kin_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">H_kin</span><span class="p">)</span> <span class="k">for</span> <span class="n">H_kin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_kin_list</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">psi_0_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">psi_0</span><span class="p">)</span> <span class="k">for</span> <span class="n">psi_0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_0_list</span><span class="p">]</span></div>

<div class="viewcode-block" id="SchroedingerMixture.copy_with_all_numpy"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.copy_with_all_numpy">[docs]</a>    <span class="k">def</span> <span class="nf">copy_with_all_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">System</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">System</span><span class="o">.</span><span class="n">a_s_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_s_array</span><span class="p">)</span>
        <span class="n">System</span><span class="o">.</span><span class="n">a_dd_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_dd_array</span><span class="p">)</span>

        <span class="n">System</span><span class="o">.</span><span class="n">k_squared</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_squared</span><span class="p">)</span>

        <span class="n">System</span><span class="o">.</span><span class="n">V_k_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span><span class="p">)</span>
        <span class="n">System</span><span class="o">.</span><span class="n">V_val</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_val</span><span class="p">)</span>

        <span class="n">System</span><span class="o">.</span><span class="n">A</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>

        <span class="n">System</span><span class="o">.</span><span class="n">H_kin</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_kin</span><span class="p">)</span>
        <span class="n">System</span><span class="o">.</span><span class="n">H_kin_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">H_kin</span><span class="p">)</span> <span class="k">for</span> <span class="n">H_kin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_kin_list</span><span class="p">]</span>

        <span class="n">System</span><span class="o">.</span><span class="n">psi_0_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">psi_0</span><span class="p">)</span> <span class="k">for</span> <span class="n">psi_0</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_0_list</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">System</span></div>


<div class="viewcode-block" id="SchroedingerMixture.func_energy"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.func_energy">[docs]</a>    <span class="k">def</span> <span class="nf">func_energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        (V_+)**5/2 + (V_-)**5/2</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">eta_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_s_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_s_array</span>
                                 <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_dd_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_dd_array</span> <span class="o">*</span> <span class="n">functions</span><span class="o">.</span><span class="n">dipol_dipol</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
                                 <span class="p">)</span>
        <span class="n">eta_aa</span> <span class="o">=</span> <span class="n">eta_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">eta_ab</span> <span class="o">=</span> <span class="n">eta_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">eta_bb</span> <span class="o">=</span> <span class="n">eta_array</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">energy_prefactor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span> <span class="o">/</span> <span class="mf">15.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="k">return</span> <span class="n">energy_prefactor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">scimath</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numbas</span><span class="o">.</span><span class="n">f_lam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">eta_aa</span><span class="p">,</span> <span class="n">eta_bb</span><span class="p">,</span> <span class="n">eta_ab</span><span class="p">))</span> <span class="o">**</span> <span class="mf">5.0</span>
            <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">scimath</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numbas</span><span class="o">.</span><span class="n">f_lam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">eta_aa</span><span class="p">,</span> <span class="n">eta_bb</span><span class="p">,</span> <span class="n">eta_ab</span><span class="p">))</span> <span class="o">**</span> <span class="mf">5.0</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="SchroedingerMixture.func_f_symb"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.func_f_symb">[docs]</a>    <span class="k">def</span> <span class="nf">func_f_symb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">func</span><span class="p">:</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">eta_a</span><span class="p">,</span> <span class="n">eta_b</span><span class="p">):</span>
        <span class="n">eta_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_s_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_s_array</span>
                                 <span class="o">+</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_dd_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_dd_array</span> <span class="o">*</span> <span class="p">(</span>
                                         <span class="n">u</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">)</span>
                                 <span class="p">)</span>
        <span class="n">eta_aa</span> <span class="o">=</span> <span class="n">eta_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">eta_ab</span> <span class="o">=</span> <span class="n">eta_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">eta_bb</span> <span class="o">=</span> <span class="n">eta_array</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

        <span class="c1"># TODO: why do we get nan here for eta_aa = 0.9 for some values</span>
        <span class="c1"># eta_aa: float64 = 0.9</span>
        <span class="c1"># eta_bb: float64 = 0.9</span>
        <span class="c1"># eta_ab: float64 = 0.9</span>
        <span class="n">func_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">func</span><span class="p">(</span><span class="n">eta_aa</span><span class="p">,</span> <span class="n">eta_bb</span><span class="p">,</span> <span class="n">eta_ab</span><span class="p">,</span> <span class="n">eta_a</span><span class="p">,</span> <span class="n">eta_b</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">func_u</span></div>

<div class="viewcode-block" id="SchroedingerMixture.mu_lhy_integrand"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.mu_lhy_integrand">[docs]</a>    <span class="k">def</span> <span class="nf">mu_lhy_integrand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">eta_dVdn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">eta_array</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_s_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_s_array</span>
                                 <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_dd_factor</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_dd_array</span> <span class="o">*</span> <span class="n">functions</span><span class="o">.</span><span class="n">dipol_dipol</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
                                 <span class="p">)</span>
        <span class="n">eta_aa</span> <span class="o">=</span> <span class="n">eta_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">eta_ab</span> <span class="o">=</span> <span class="n">eta_array</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">eta_bb</span> <span class="o">=</span> <span class="n">eta_array</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">term1</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">scimath</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numbas</span><span class="o">.</span><span class="n">f_lam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">eta_aa</span><span class="p">,</span> <span class="n">eta_bb</span><span class="p">,</span> <span class="n">eta_ab</span><span class="p">))</span> <span class="o">**</span> <span class="mf">3.0</span>
                 <span class="o">*</span> <span class="n">eta_dVdn</span><span class="p">(</span><span class="n">lam</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">eta_aa</span><span class="o">=</span><span class="n">eta_aa</span><span class="p">,</span> <span class="n">eta_bb</span><span class="o">=</span><span class="n">eta_bb</span><span class="p">,</span> <span class="n">eta_ab</span><span class="o">=</span><span class="n">eta_ab</span><span class="p">)</span>
                 <span class="p">)</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">scimath</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">numbas</span><span class="o">.</span><span class="n">f_lam</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">eta_aa</span><span class="p">,</span> <span class="n">eta_bb</span><span class="p">,</span> <span class="n">eta_ab</span><span class="p">))</span> <span class="o">**</span> <span class="mf">3.0</span>
                 <span class="o">*</span> <span class="n">eta_dVdn</span><span class="p">(</span><span class="n">lam</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">eta_aa</span><span class="o">=</span><span class="n">eta_aa</span><span class="p">,</span> <span class="n">eta_bb</span><span class="o">=</span><span class="n">eta_bb</span><span class="p">,</span> <span class="n">eta_ab</span><span class="o">=</span><span class="n">eta_ab</span><span class="p">)</span>
                 <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="SchroedingerMixture.eta_dVdna"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.eta_dVdna">[docs]</a>    <span class="k">def</span> <span class="nf">eta_dVdna</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lam</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">eta_aa</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">eta_bb</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">eta_ab</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numbas</span><span class="o">.</span><span class="n">eta_dVdna_jit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">eta_aa</span><span class="p">,</span> <span class="n">eta_bb</span><span class="p">,</span> <span class="n">eta_ab</span><span class="p">)</span></div>

<div class="viewcode-block" id="SchroedingerMixture.eta_dVdnb"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.eta_dVdnb">[docs]</a>    <span class="k">def</span> <span class="nf">eta_dVdnb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lam</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">eta_aa</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">eta_bb</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">eta_ab</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">numbas</span><span class="o">.</span><span class="n">eta_dVdnb_jit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="n">lam</span><span class="p">,</span> <span class="n">eta_aa</span><span class="p">,</span> <span class="n">eta_bb</span><span class="p">,</span> <span class="n">eta_ab</span><span class="p">)</span></div>

<div class="viewcode-block" id="SchroedingerMixture.get_mu_lhy_list"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.get_mu_lhy_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_mu_lhy_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">density_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="n">density_A</span><span class="p">,</span> <span class="n">density_total</span> <span class="o">=</span> <span class="n">get_A_density_total</span><span class="p">(</span><span class="n">density_list</span><span class="p">)</span>

        <span class="n">mu_lhy_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mu_lhy_interpolation</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu_lhy_interpolation_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
                <span class="n">mu_lhy</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mu_lhy_interpolation</span><span class="p">(</span><span class="n">density_A</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="o">*</span> <span class="n">density_total</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">**</span> <span class="mf">1.5</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mu_lhy</span> <span class="o">=</span> <span class="n">mu_lhy_interpolation</span><span class="p">(</span><span class="n">density_A</span><span class="p">)</span> <span class="o">*</span> <span class="n">density_total</span> <span class="o">**</span> <span class="mf">1.5</span>

            <span class="n">mu_lhy_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mu_lhy</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mu_lhy_list</span></div>

<div class="viewcode-block" id="SchroedingerMixture.get_energy_lhy"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.get_energy_lhy">[docs]</a>    <span class="k">def</span> <span class="nf">get_energy_lhy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">density_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">density_A</span><span class="p">,</span> <span class="n">density_total</span> <span class="o">=</span> <span class="n">get_A_density_total</span><span class="p">(</span><span class="n">density_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
            <span class="n">energy_lhy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_helper_function</span><span class="p">(</span><span class="n">density_A</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="o">*</span> <span class="n">density_total</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">**</span> <span class="mf">2.5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">energy_lhy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_helper_function</span><span class="p">(</span><span class="n">density_A</span><span class="p">)</span> <span class="o">*</span> <span class="n">density_total</span> <span class="o">**</span> <span class="mf">2.5</span>

        <span class="k">return</span> <span class="n">energy_lhy</span></div>

<div class="viewcode-block" id="SchroedingerMixture.save_psi_val"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.save_psi_val">[docs]</a>    <span class="k">def</span> <span class="nf">save_psi_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">filename_steps</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">steps_format</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">arr_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">arr_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">arr_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span>
        <span class="n">path_output</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">filename_steps</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">steps_format</span> <span class="o">%</span> <span class="n">frame</span><span class="si">}</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;.npz&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_output</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">g</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">psi_val_list</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="p">[</span><span class="n">psi_val</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">psi_val</span> <span class="ow">in</span> <span class="n">arr_list</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="c1"># cupy is installed, but data was saved as numpy array</span>
                    <span class="n">psi_val_list</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="p">[</span><span class="n">psi_val</span> <span class="k">for</span> <span class="n">psi_val</span> <span class="ow">in</span> <span class="n">arr_list</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">psi_val_list</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">arr_list</span>
            <span class="n">cp</span><span class="o">.</span><span class="n">savez_compressed</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">psi_val_list</span><span class="o">=</span><span class="n">psi_val_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="SchroedingerMixture.use_summary"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.use_summary">[docs]</a>    <span class="k">def</span> <span class="nf">use_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">SchroedingerMixtureSummary</span><span class="p">,</span>
                                                                       <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="n">Summary</span><span class="p">:</span> <span class="n">SchroedingerMixtureSummary</span> <span class="o">=</span> <span class="n">SchroedingerMixtureSummary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">Summary</span><span class="o">.</span><span class="n">convert_all_to_numpy</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">Summary</span><span class="p">,</span> <span class="n">summary_name</span></div>

<div class="viewcode-block" id="SchroedingerMixture.load_summary"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.load_summary">[docs]</a>    <span class="k">def</span> <span class="nf">load_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">steps_format</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                     <span class="n">summary_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SchroedingerMixtureSummary_&quot;</span><span class="p">,</span>
                     <span class="n">host</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">summary_name</span><span class="p">:</span>
            <span class="n">system_summary_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">summary_name</span> <span class="o">+</span> <span class="n">steps_format</span> <span class="o">%</span> <span class="n">frame</span> <span class="o">+</span> <span class="s2">&quot;.pkl&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">system_summary_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">steps_format</span> <span class="o">%</span> <span class="n">frame</span> <span class="o">+</span> <span class="s2">&quot;.pkl&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># load SchroedingerSummary</span>
            <span class="k">if</span> <span class="n">host</span><span class="p">:</span>
                <span class="n">sftp</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">sftp</span><span class="p">()</span>
                <span class="k">with</span> <span class="n">sftp</span><span class="o">.</span><span class="n">file</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">system_summary_path</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">SystemSummary</span><span class="p">:</span> <span class="n">SchroedingerMixtureSummary</span> <span class="o">=</span> <span class="n">dill</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">SystemSummary</span><span class="o">.</span><span class="n">copy_to</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">system_summary_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">SystemSummary</span><span class="p">:</span> <span class="n">SchroedingerMixtureSummary</span> <span class="o">=</span> <span class="n">dill</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">SystemSummary</span><span class="o">.</span><span class="n">copy_to</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">system_summary_path</span><span class="si">}</span><span class="s2"> not found.</span><span class="se">\n</span><span class="s2"> </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="SchroedingerMixture.load_mu"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.load_mu">[docs]</a>    <span class="k">def</span> <span class="nf">load_mu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">filename_mu_a</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;interpolator_mu_a.pkl&quot;</span><span class="p">,</span>
                <span class="n">filename_mu_b</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;interpolator_mu_b.pkl&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading mu from interpolating pickles ... &quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_path</span><span class="p">,</span> <span class="n">filename_mu_a</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">mu_a</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_path</span><span class="p">,</span> <span class="n">filename_mu_b</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">mu_b</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;mu pickles sucessfully loaded!&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mu_a</span><span class="p">,</span> <span class="n">mu_b</span></div>

<div class="viewcode-block" id="SchroedingerMixture.load_lhy"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.load_lhy">[docs]</a>    <span class="k">def</span> <span class="nf">load_lhy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename_lhy</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;interpolator_lhy_energy.pkl&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading lhy from interpolating pickles ... &quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_path</span><span class="p">,</span> <span class="n">filename_lhy</span><span class="p">),</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">lhy_energy</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;lhy pickle sucessfully loaded!&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lhy_energy</span></div>

<div class="viewcode-block" id="SchroedingerMixture.energy_density_interaction_explicit"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.energy_density_interaction_explicit">[docs]</a>    <span class="k">def</span> <span class="nf">energy_density_interaction_explicit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">density_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">dV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_element</span><span class="p">(</span><span class="n">fourier_space</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">density_array</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">density_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">density_density</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;i...,j...-&gt;ij...&quot;</span><span class="p">,</span> <span class="n">density_array</span><span class="p">,</span> <span class="n">density_array</span><span class="p">)</span>

        <span class="c1"># density_density and density_U_dd are (2, 2, res_x, res_y, res_z)</span>
        <span class="c1"># the (2,2) part needs to be summed after one-by-one multiplication</span>
        <span class="c1"># [[a11 * b11, a12 * a12], [a21 * b21, a22 * b22]] with (2, 2) matrices</span>
        <span class="c1"># formally, as we sum in real space dV is just a constant multiplication, so summation</span>
        <span class="c1"># over all 5 dimensions is fine</span>
        <span class="n">energy_scattering</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij..., ijklm-&gt;ij&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_s_array</span><span class="p">,</span> <span class="n">density_density</span><span class="p">)</span>

        <span class="c1"># if stack_shift is used U_dd has higher dimensionality, but resulting density_U_dd the same</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_shift</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">U_dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_U_dd</span><span class="p">(</span><span class="n">density_list</span><span class="p">)</span>
            <span class="n">density_U_dd</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijklm, jklm-&gt;ijklm&quot;</span><span class="p">,</span> <span class="n">U_dd</span><span class="p">,</span> <span class="n">density_array</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">U_dd_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_U_dd_list</span><span class="p">(</span><span class="n">density_list</span><span class="p">)</span>
            <span class="n">U_dd_array</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">U_dd_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">density_U_dd</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;i...,j...-&gt;ij...&quot;</span><span class="p">,</span> <span class="n">U_dd_array</span><span class="p">,</span> <span class="n">density_array</span><span class="p">)</span>

        <span class="n">energy_dipol_dipol</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij..., ijklm-&gt;ij&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_dd_array</span><span class="p">,</span> <span class="n">density_U_dd</span><span class="p">)</span>

        <span class="c1"># E_scatter = 0.5 * np.sum(energy_scattering).real * dV</span>
        <span class="c1"># E_dd = np.sum(energy_dipol_dipol).real * dV</span>
        <span class="n">E_scatter</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">energy_scattering</span><span class="p">)</span> <span class="o">*</span> <span class="n">dV</span>
        <span class="n">E_dd</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">energy_dipol_dipol</span><span class="p">)</span><span class="o">.</span><span class="n">real</span> <span class="o">*</span> <span class="n">dV</span>
        <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
            <span class="n">E_scatter</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">E_scatter</span><span class="p">)</span>
            <span class="n">E_dd</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">E_dd</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">E_dd</span><span class="p">,</span> <span class="n">E_scatter</span></div>

<div class="viewcode-block" id="SchroedingerMixture.energy_density_interaction"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.energy_density_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">energy_density_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">density_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">dV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_element</span><span class="p">(</span><span class="n">fourier_space</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">density_array</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">density_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">density_density</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;i...,j...-&gt;ij...&quot;</span><span class="p">,</span> <span class="n">density_array</span><span class="p">,</span> <span class="n">density_array</span><span class="p">)</span>

        <span class="c1"># density_density and density_U_dd are (2, 2, res_x, res_y, res_z)</span>
        <span class="c1"># the (2,2) part needs to be summed after one-by-one multiplication</span>
        <span class="c1"># [[a11 * b11, a12 * a12], [a21 * b21, a22 * b22]] with (2, 2) matrices</span>
        <span class="c1"># formally, as we sum in real space dV is just a constant multiplication, so summation</span>
        <span class="c1"># over all 5 dimensions is fine</span>
        
        <span class="c1"># there are 3 ways when to sum (verison c is the fastest):</span>
        <span class="c1"># a. getting a (2, 2, res_x, res_y, res_z) matrix</span>
        <span class="c1"># b. getting a (res_x, res_y, res_z) matrix, where (2,2) grid part is already summed</span>
        <span class="c1"># c. getting a (2, 2) matrix, where the (res_x, res_y, res_z) is already summed</span>

        <span class="c1"># energy_dipol_dipol_a = np.einsum(&quot;ij..., ijklm-&gt;ijklm&quot;, self.a_s_array, density_density)</span>
        <span class="c1"># energy_dipol_dipol_b = np.einsum(&quot;ij..., ijklm-&gt;klm&quot;, self.a_s_array, density_density)</span>
        <span class="n">energy_scattering</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij..., ijklm-&gt;ij&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_s_array</span><span class="p">,</span> <span class="n">density_density</span><span class="p">)</span>

        <span class="c1"># if stack_shift is used U_dd has higher dimensionality, but resulting density_U_dd the same</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_shift</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">U_dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_U_dd</span><span class="p">(</span><span class="n">density_list</span><span class="p">)</span>
            <span class="n">density_U_dd</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijklm, jklm-&gt;ijklm&quot;</span><span class="p">,</span> <span class="n">U_dd</span><span class="p">,</span> <span class="n">density_array</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">U_dd_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_U_dd_list</span><span class="p">(</span><span class="n">density_list</span><span class="p">)</span>
            <span class="n">U_dd_array</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">U_dd_list</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">density_U_dd</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;i...,j...-&gt;ij...&quot;</span><span class="p">,</span> <span class="n">U_dd_array</span><span class="p">,</span> <span class="n">density_array</span><span class="p">)</span>

        <span class="n">energy_dipol_dipol</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij..., ijklm-&gt;ij&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_dd_array</span><span class="p">,</span> <span class="n">density_U_dd</span><span class="p">)</span>

        <span class="n">E_dd</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">energy_scattering</span> <span class="o">+</span> <span class="n">energy_dipol_dipol</span><span class="p">)</span><span class="o">.</span><span class="n">real</span> <span class="o">*</span> <span class="n">dV</span>

        <span class="k">return</span> <span class="n">E_dd</span></div>

<div class="viewcode-block" id="SchroedingerMixture.get_E"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.get_E">[docs]</a>    <span class="k">def</span> <span class="nf">get_E</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># update for energy calculation</span>
        <span class="n">density_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density_list</span><span class="p">(</span><span class="n">jit</span><span class="o">=</span><span class="n">numba_used</span><span class="p">)</span>
        <span class="n">mu_lhy_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mu_lhy_list</span><span class="p">(</span><span class="n">density_list</span><span class="p">)</span>

        <span class="c1"># use normalized inputs for energy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy</span><span class="p">(</span><span class="n">density_list</span><span class="p">,</span> <span class="n">mu_lhy_list</span><span class="p">)</span></div>


<div class="viewcode-block" id="SchroedingerMixture.get_E_pot"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.get_E_pot">[docs]</a>    <span class="k">def</span> <span class="nf">get_E_pot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">density_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">dV</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">E_pot_ext_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">density</span> <span class="ow">in</span> <span class="n">density_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
                <span class="n">E_pot_ext_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sum_dV</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">density</span><span class="p">)</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_val</span><span class="p">),</span> <span class="n">dV</span><span class="o">=</span><span class="n">dV</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">E_pot_ext_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sum_dV</span><span class="p">(</span><span class="n">density</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_val</span><span class="p">,</span> <span class="n">dV</span><span class="o">=</span><span class="n">dV</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">E_pot_ext_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sum_dV</span><span class="p">(</span><span class="n">density</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_val</span><span class="p">,</span> <span class="n">dV</span><span class="o">=</span><span class="n">dV</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">E_pot_arr</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">E_pot_ext_list</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">E_pot_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">E_pot_ext_list</span><span class="p">)</span>
        <span class="c1"># add all components</span>
        <span class="n">E_pot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">E_pot_arr</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">E_pot</span></div>


<div class="viewcode-block" id="SchroedingerMixture.get_E_kin"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.get_E_kin">[docs]</a>    <span class="k">def</span> <span class="nf">get_E_kin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dV</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">psi_val_array</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">)</span>
        <span class="n">fft_dim</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">psi_val_array</span><span class="o">.</span><span class="n">ndim</span><span class="p">)</span>
        <span class="n">psi_val_array_k</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">psi_val_array</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">fft_dim</span><span class="p">)</span>
        <span class="n">H_kin_array</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_kin_list</span><span class="p">)</span>
        <span class="n">E_kin_grid_helper</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;i...,i...-&gt;i...&quot;</span><span class="p">,</span> <span class="n">H_kin_array</span><span class="p">,</span> <span class="n">psi_val_array_k</span><span class="p">)</span>
        <span class="n">E_kin_grid_helper_fft</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">E_kin_grid_helper</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="n">fft_dim</span><span class="p">)</span>
        <span class="n">E_kin_grid</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;i...,i...-&gt;i...&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">psi_val_array</span><span class="p">),</span> <span class="n">E_kin_grid_helper_fft</span><span class="p">)</span>
        <span class="n">E_kin_arr</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">fromiter</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sum_dV</span><span class="p">,</span> <span class="n">dV</span><span class="o">=</span><span class="n">dV</span><span class="p">),</span> <span class="n">E_kin_grid</span><span class="o">.</span><span class="n">real</span><span class="p">),</span>
                                 <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_list</span><span class="p">)</span>
        <span class="n">E_kin</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">E_kin_arr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
            <span class="n">E_kin</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asnumpy</span><span class="p">(</span><span class="n">E_kin</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">E_kin</span></div>

<div class="viewcode-block" id="SchroedingerMixture.get_mu_explicit"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.get_mu_explicit">[docs]</a>    <span class="k">def</span> <span class="nf">get_mu_explicit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psi_previous_list</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mu_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="p">(</span><span class="n">psi_val</span><span class="p">,</span> <span class="n">psi_previous</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">,</span> <span class="n">psi_previous_list</span><span class="p">):</span>
            <span class="n">integrand</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">psi_previous</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">psi_val</span> <span class="o">-</span> <span class="n">psi_previous</span><span class="p">)</span>
            <span class="n">mu_list</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum_dV</span><span class="p">(</span><span class="n">integrand</span><span class="p">))</span>
        
        <span class="k">return</span> <span class="n">mu_list</span></div>

<div class="viewcode-block" id="SchroedingerMixture.get_E_explicit"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.get_E_explicit">[docs]</a>    <span class="k">def</span> <span class="nf">get_E_explicit</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_element</span><span class="p">(</span><span class="n">fourier_space</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># update for energy calculation</span>
        <span class="n">density_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density_list</span><span class="p">(</span><span class="n">jit</span><span class="o">=</span><span class="n">numba_used</span><span class="p">)</span>
        <span class="c1"># density_list_per_particle = []</span>
        <span class="c1"># for density, N in zip(density_list, self.N_list):</span>
        <span class="c1">#     # norm</span>
            <span class="c1"># density_list_per_particle.append((1.0 / N) * density)</span>

        <span class="n">E_lhy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum_dV</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_energy_lhy</span><span class="p">(</span><span class="n">density_list</span><span class="p">),</span> <span class="n">dV</span><span class="o">=</span><span class="n">dV</span><span class="p">)</span>
        <span class="n">E_dd</span><span class="p">,</span> <span class="n">E_scatter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_density_interaction_explicit</span><span class="p">(</span><span class="n">density_list</span><span class="p">)</span>
        <span class="n">E_pot</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_E_pot</span><span class="p">(</span><span class="n">density_list</span><span class="p">,</span> <span class="n">dV</span><span class="o">=</span><span class="n">dV</span><span class="p">)</span>
        <span class="n">E_kin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_E_kin</span><span class="p">(</span><span class="n">dV</span><span class="o">=</span><span class="n">dV</span><span class="p">)</span>

        <span class="c1"># use normalized inputs for energy</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_list</span><span class="p">)</span>
        <span class="n">E</span> <span class="o">=</span> <span class="p">(</span><span class="n">E_kin</span> <span class="o">+</span> <span class="n">E_pot</span> <span class="o">+</span> <span class="n">E_lhy</span> <span class="o">+</span> <span class="n">E_dd</span> <span class="o">+</span> <span class="n">E_scatter</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Check E: </span><span class="si">{</span><span class="n">E</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">E</span></div>

<div class="viewcode-block" id="SchroedingerMixture.energy"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.energy">[docs]</a>    <span class="k">def</span> <span class="nf">energy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">density_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">mu_lhy_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Input psi_1, psi_2 need to be normalized.</span>
<span class="sd">        density1 and density2 need to be build by the normalized psi_1, psi_2.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_element</span><span class="p">(</span><span class="n">fourier_space</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">mu_lhy_part_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mu_lhy</span><span class="p">,</span> <span class="n">density</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">mu_lhy_list</span><span class="p">,</span> <span class="n">density_list</span><span class="p">):</span>
            <span class="n">mu_lhy_part_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sum_dV</span><span class="p">(</span><span class="n">mu_lhy</span> <span class="o">*</span> <span class="n">density</span><span class="p">,</span> <span class="n">dV</span><span class="o">=</span><span class="n">dV</span><span class="p">))</span>
        <span class="n">mu_lhy_part</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mu_lhy_part_list</span><span class="p">))</span>

        <span class="n">p_int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">energy_density_interaction</span><span class="p">(</span><span class="n">density_list</span><span class="p">)</span>

        <span class="n">E_lhy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum_dV</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_energy_lhy</span><span class="p">(</span><span class="n">density_list</span><span class="p">),</span> <span class="n">dV</span><span class="o">=</span><span class="n">dV</span><span class="p">)</span>

        <span class="c1"># p_ext_list: List[float] = []</span>
        <span class="c1"># for density in density_list:</span>
        <span class="c1">#     p_ext_list.append(self.sum_dV(density * self.V_val, dV=dV))</span>
        <span class="c1"># p_ext = np.array(p_ext_list)</span>

        <span class="c1"># psi_val_array = np.array(self.psi_val_list)</span>
        <span class="c1"># H_kin_array = np.array(self.H_kin_list)</span>
        <span class="c1"># E_kin_grid = np.einsum(&quot;i...,i...-&gt;i...&quot;, H_kin_array, psi_val_array)</span>
        <span class="c1"># E_kin = np.fromiter(map(functools.partial(self.sum_dV, dV=dV), E_kin_grid.real),</span>
        <span class="c1">#                     dtype=float)</span>

        <span class="n">N_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_list</span><span class="p">)</span>
        <span class="n">chem_pot_N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu_arr</span><span class="p">,</span> <span class="n">N_array</span><span class="p">)</span>

        <span class="n">E</span> <span class="o">=</span> <span class="p">(</span><span class="n">chem_pot_N</span> <span class="o">+</span> <span class="n">p_int</span> <span class="o">+</span> <span class="n">E_lhy</span> <span class="o">-</span> <span class="n">mu_lhy_part</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">N_array</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">E</span></div>

<div class="viewcode-block" id="SchroedingerMixture.get_density_list"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.get_density_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_density_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">cupy_used</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="n">density_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">psi_val</span><span class="p">,</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">jit</span><span class="p">:</span>
                <span class="n">density_N</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="n">numbas</span><span class="o">.</span><span class="n">get_density_jit</span><span class="p">(</span><span class="n">psi_val</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">density_N</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density</span><span class="p">(</span><span class="n">psi_val</span><span class="p">,</span> <span class="n">jit</span><span class="o">=</span><span class="n">jit</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">density_N</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density</span><span class="p">(</span><span class="n">psi_val</span><span class="p">,</span> <span class="n">jit</span><span class="o">=</span><span class="n">jit</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">density_N</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">N</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density</span><span class="p">(</span><span class="n">psi_val</span><span class="p">,</span> <span class="n">jit</span><span class="o">=</span><span class="n">jit</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
                    <span class="n">density_N</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">density_N</span><span class="p">)</span>

            <span class="n">density_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">density_N</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">density_list</span></div>

<div class="viewcode-block" id="SchroedingerMixture.get_center_of_mass"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.get_center_of_mass">[docs]</a>    <span class="k">def</span> <span class="nf">get_center_of_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">Mx0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mx1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">My0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">My1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">Mz0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mz1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">p</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the center of mass of the System.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_default</span><span class="p">(</span><span class="n">Mx0</span><span class="p">,</span> <span class="n">Mx1</span><span class="p">,</span> <span class="n">My0</span><span class="p">,</span> <span class="n">My1</span><span class="p">,</span> <span class="n">Mz0</span><span class="p">,</span> <span class="n">Mz1</span><span class="p">)</span>
        <span class="n">prob_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">density</span><span class="p">[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">:</span><span class="n">z1</span><span class="p">]</span>
                     <span class="k">for</span> <span class="n">density</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density_list</span><span class="p">(</span><span class="n">jit</span><span class="o">=</span><span class="n">numba_used</span><span class="p">)]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mesh_list</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span><span class="p">)</span>
        <span class="n">com_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">prob</span> <span class="ow">in</span> <span class="n">prob_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
                <span class="n">center_of_mass_along_axis</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">r_i</span><span class="p">)</span> <span class="o">**</span> <span class="n">p</span> <span class="k">for</span> <span class="n">r_i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">center_of_mass_along_axis</span> <span class="o">=</span> <span class="p">[</span><span class="n">prob</span> <span class="o">*</span> <span class="n">r_i</span> <span class="o">**</span> <span class="n">p</span> <span class="k">for</span> <span class="n">r_i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span>
            <span class="n">com_list</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">trapez_integral</span><span class="p">(</span><span class="n">com_along_axis</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">trapez_integral</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">com_along_axis</span> <span class="ow">in</span> <span class="n">center_of_mass_along_axis</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">com_list</span></div>

<div class="viewcode-block" id="SchroedingerMixture.get_parity"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.get_parity">[docs]</a>    <span class="k">def</span> <span class="nf">get_parity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                   <span class="n">axis</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">Mx0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mx1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">My0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">My1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">Mz0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mz1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_default</span><span class="p">(</span><span class="n">Mx0</span><span class="p">,</span> <span class="n">Mx1</span><span class="p">,</span> <span class="n">My0</span><span class="p">,</span> <span class="n">My1</span><span class="p">,</span> <span class="n">Mz0</span><span class="p">,</span> <span class="n">Mz1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axis_list</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">axis_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">axis</span><span class="p">]</span>
        <span class="n">parity_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">psi_val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">:</span>
            <span class="n">parity_axis_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">axis</span> <span class="ow">in</span> <span class="n">axis_list</span><span class="p">:</span>
                <span class="n">psi_under0</span><span class="p">,</span> <span class="n">psi_over0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">psi_val</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
                    <span class="n">psi_over0_reversed</span> <span class="o">=</span> <span class="n">psi_over0</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No such axis (</span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s2">). Choose 0, 1 or 2 for axis x, y or z.&quot;</span><span class="p">)</span>

                <span class="n">parity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trapez_integral</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                    <span class="n">psi_under0</span><span class="p">[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">:</span><span class="n">z1</span><span class="p">]</span> <span class="o">-</span> <span class="n">psi_over0_reversed</span><span class="p">[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">:</span><span class="n">z1</span><span class="p">])</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span>
                <span class="n">parity_axis_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parity</span><span class="p">)</span>
            <span class="n">parity_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parity_axis_list</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">parity_list</span></div>

<div class="viewcode-block" id="SchroedingerMixture.check_N"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.check_N">[docs]</a>    <span class="k">def</span> <span class="nf">check_N</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates :math:`N_i = \int \\mathcal{d}\vec{r} |\psi_{i}(r)|^2`</span>
<span class="sd">        Returns [N_1, N_2, N]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">N_list_check</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">psi_val</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">N_list</span><span class="p">)):</span>
            <span class="n">N_list_check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_norm</span><span class="p">(</span><span class="n">func_val</span><span class="o">=</span><span class="n">psi_val</span><span class="p">))</span>
        <span class="n">N_list_check</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">N_list_check</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">N_list_check</span></div>


<div class="viewcode-block" id="SchroedingerMixture.distmat"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.distmat">[docs]</a>    <span class="k">def</span> <span class="nf">distmat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]):</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">mask</span><span class="p">[</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">index</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="n">distance_transform_edt</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span></div>

<div class="viewcode-block" id="SchroedingerMixture.get_contrast_old"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.get_contrast_old">[docs]</a>    <span class="k">def</span> <span class="nf">get_contrast_old</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                   <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                   <span class="n">Mx0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mx1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">My0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">My1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">Mz0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mz1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_default</span><span class="p">(</span><span class="n">Mx0</span><span class="p">,</span> <span class="n">Mx1</span><span class="p">,</span> <span class="n">My0</span><span class="p">,</span> <span class="n">My1</span><span class="p">,</span> <span class="n">Mz0</span><span class="p">,</span> <span class="n">Mz1</span><span class="p">)</span>
        <span class="n">prob_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density_list</span><span class="p">(</span><span class="n">jit</span><span class="o">=</span><span class="n">numba_used</span><span class="p">)</span>
        <span class="n">bec_contrast_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">N</span><span class="p">,</span> <span class="n">prob</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_list</span><span class="p">,</span> <span class="n">prob_list</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">prob</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">:</span><span class="n">z1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">bec_min_edgeless</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">bec_max_edgeless</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">bec_contrast_edgeless</span> <span class="o">=</span> <span class="p">(</span><span class="n">bec_max_edgeless</span> <span class="o">-</span> <span class="n">bec_min_edgeless</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                    <span class="n">bec_max_edgeless</span> <span class="o">+</span> <span class="n">bec_min_edgeless</span><span class="p">)</span>
            <span class="n">bec_contrast_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bec_contrast_edgeless</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bec_contrast_list</span></div>

<div class="viewcode-block" id="SchroedingerMixture.get_contrast_old_smart"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.get_contrast_old_smart">[docs]</a>    <span class="k">def</span> <span class="nf">get_contrast_old_smart</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                               <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                               <span class="n">Mx0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mx1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">My0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">My1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">Mz0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mz1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_default</span><span class="p">(</span><span class="n">Mx0</span><span class="p">,</span> <span class="n">Mx1</span><span class="p">,</span> <span class="n">My0</span><span class="p">,</span> <span class="n">My1</span><span class="p">,</span> <span class="n">Mz0</span><span class="p">,</span> <span class="n">Mz1</span><span class="p">)</span>

        <span class="n">prob_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density_list</span><span class="p">(</span><span class="n">jit</span><span class="o">=</span><span class="n">numba_used</span><span class="p">)</span>

        <span class="n">bec_contrast_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">N</span><span class="p">,</span> <span class="n">prob</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_list</span><span class="p">,</span> <span class="n">prob_list</span><span class="p">):</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">prob</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">mask</span><span class="p">[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">:</span><span class="n">z1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="n">min_on_edge_bool</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">slice_x0</span><span class="p">,</span> <span class="n">slice_x1</span><span class="p">,</span> <span class="n">slice_y0</span><span class="p">,</span> <span class="n">slice_y1</span><span class="p">,</span> <span class="n">slice_z0</span><span class="p">,</span> <span class="n">slice_z1</span> <span class="o">=</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span>
            <span class="k">while</span> <span class="n">min_on_edge_bool</span><span class="p">:</span>
                <span class="n">mask_slice</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">prob</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
                <span class="n">mask_slice</span><span class="p">[</span><span class="n">slice_x0</span><span class="p">:</span><span class="n">slice_x1</span><span class="p">,</span> <span class="n">slice_y0</span><span class="p">:</span><span class="n">slice_y1</span><span class="p">,</span> <span class="n">slice_z0</span><span class="p">:</span><span class="n">slice_z1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">bec_min_edgeless_pos</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">minimum_position</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">mask_slice</span><span class="p">)</span>

                <span class="p">(</span><span class="n">min_on_edge_bool</span><span class="p">,</span>
                <span class="n">slice_x0</span><span class="p">,</span> <span class="n">slice_x1</span><span class="p">,</span>
                <span class="n">slice_y0</span><span class="p">,</span> <span class="n">slice_y1</span><span class="p">,</span>
                <span class="n">slice_z0</span><span class="p">,</span> <span class="n">slice_z1</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">on_edge</span><span class="p">(</span><span class="n">bec_min_edgeless_pos</span><span class="p">,</span>
                                                   <span class="n">slice_x0</span><span class="p">,</span> <span class="n">slice_x1</span><span class="p">,</span>
                                                   <span class="n">slice_y0</span><span class="p">,</span> <span class="n">slice_y1</span><span class="p">,</span>
                                                   <span class="n">slice_z0</span><span class="p">,</span> <span class="n">slice_z1</span><span class="p">)</span>

            <span class="c1"># if minimum is on edge of region, it is not a local minima,</span>
            <span class="c1"># but depends choice of the region. Thus contrast is meaningless (set to 0).</span>
            <span class="k">if</span> <span class="n">min_on_edge_bool</span><span class="p">:</span>
                <span class="n">bec_contrast_edgeless</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">bec_min_edgeless</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
                <span class="n">bec_max_edgeless</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
                <span class="n">bec_contrast_edgeless</span> <span class="o">=</span> <span class="p">(</span><span class="n">bec_max_edgeless</span> <span class="o">-</span> <span class="n">bec_min_edgeless</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                        <span class="n">bec_max_edgeless</span> <span class="o">+</span> <span class="n">bec_min_edgeless</span><span class="p">)</span>

            <span class="n">bec_contrast_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bec_contrast_edgeless</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bec_contrast_list</span></div>

<div class="viewcode-block" id="SchroedingerMixture.on_edge"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.on_edge">[docs]</a>    <span class="k">def</span> <span class="nf">on_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">,</span>
                 <span class="n">Mx0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mx1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">My0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">My1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">Mz0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mz1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="c1"># test if indices are on th edge</span>

        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_default</span><span class="p">(</span><span class="n">Mx0</span><span class="p">,</span> <span class="n">Mx1</span><span class="p">,</span> <span class="n">My0</span><span class="p">,</span> <span class="n">My1</span><span class="p">,</span> <span class="n">Mz0</span><span class="p">,</span> <span class="n">Mz1</span><span class="p">)</span>
        <span class="n">x_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">]</span>
        <span class="n">y_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">]</span>
        <span class="n">z_bounds</span> <span class="o">=</span> <span class="p">[</span><span class="n">z0</span><span class="p">,</span> <span class="n">z1</span><span class="p">]</span>

        <span class="c1"># return True whenever it was changed (it was on edge), gives back smaller slice</span>
        <span class="k">if</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">x_bounds</span><span class="p">:</span>
            <span class="n">changed</span><span class="p">,</span> <span class="n">x0_new</span><span class="p">,</span> <span class="n">x1_new</span> <span class="o">=</span> <span class="n">smaller_slice</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">x0_new</span><span class="p">,</span> <span class="n">x1_new</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span>

        <span class="k">if</span> <span class="n">indices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">y_bounds</span><span class="p">:</span>
            <span class="n">changed</span><span class="p">,</span> <span class="n">y0_new</span><span class="p">,</span> <span class="n">y1_new</span> <span class="o">=</span> <span class="n">smaller_slice</span><span class="p">(</span><span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0_new</span><span class="p">,</span> <span class="n">y1_new</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span>

        <span class="c1"># x, y not changed</span>
        <span class="k">if</span> <span class="n">indices</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">in</span> <span class="n">z_bounds</span><span class="p">:</span>
            <span class="n">changed</span><span class="p">,</span> <span class="n">z0_new</span><span class="p">,</span> <span class="n">z1_new</span> <span class="o">=</span> <span class="n">smaller_slice</span><span class="p">(</span><span class="n">z0</span><span class="p">,</span> <span class="n">z1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">changed</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0_new</span><span class="p">,</span> <span class="n">z1_new</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># x, y, z not changed, meaning: no change in slice</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span></div>


<div class="viewcode-block" id="SchroedingerMixture.get_contrast"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.get_contrast">[docs]</a>    <span class="k">def</span> <span class="nf">get_contrast</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number_of_peaks</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">prob_min_start</span><span class="p">,</span> <span class="n">prob_step</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">,</span>
                     <span class="n">prob_min_edge</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.015</span><span class="p">,</span> <span class="n">region_threshold</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                     <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">prob_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density_list</span><span class="p">(</span><span class="n">jit</span><span class="o">=</span><span class="n">numba_used</span><span class="p">)</span>
        <span class="n">bec_contrast_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">structures</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">binary_structures</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">N</span><span class="p">,</span> <span class="n">prob</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_list</span><span class="p">,</span> <span class="n">prob_list</span><span class="p">):</span>
            <span class="n">prob_max</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>
            <span class="n">prob_min_lin_reverse</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">prob_min_start</span><span class="p">,</span> <span class="n">prob_step</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">prob_min_ratio</span> <span class="ow">in</span> <span class="n">prob_min_lin_reverse</span><span class="p">:</span>
                <span class="c1"># get biggest region</span>
                <span class="n">prob_region_outer</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prob</span> <span class="o">&gt;=</span> <span class="n">prob_min_ratio</span> <span class="o">*</span> <span class="n">prob_max</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">label_im_outer</span><span class="p">,</span> <span class="n">nb_labels_outer</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">prob_region_outer</span><span class="p">,</span>
                                                                <span class="n">structure</span><span class="o">=</span><span class="n">structures</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">sizes_outer</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">prob_region_outer</span><span class="p">,</span> <span class="n">label_im_outer</span><span class="p">,</span>
                                          <span class="nb">range</span><span class="p">(</span><span class="n">nb_labels_outer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">mask_outer</span> <span class="o">=</span> <span class="n">sizes_outer</span> <span class="o">&gt;</span> <span class="n">region_threshold</span>
                <span class="n">label_region_outer</span> <span class="o">=</span> <span class="n">mask_outer</span><span class="p">[</span><span class="n">label_im_outer</span><span class="p">]</span>
                <span class="n">region_outer</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">fill_holes</span><span class="p">(</span><span class="n">label_region_outer</span><span class="p">,</span> <span class="o">*</span><span class="n">structures</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

                <span class="c1"># remove edge</span>
                <span class="n">prob_region_inner</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prob</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">prob_min_edge</span> <span class="o">+</span> <span class="n">prob_min_ratio</span><span class="p">)</span> <span class="o">*</span> <span class="n">prob_max</span><span class="p">,</span>
                                             <span class="n">prob</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="n">label_im_inner</span><span class="p">,</span> <span class="n">nb_labels_inner</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">prob_region_inner</span><span class="p">,</span>
                                                                <span class="n">structure</span><span class="o">=</span><span class="n">structures</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">sizes_inner</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">prob_region_inner</span><span class="p">,</span> <span class="n">label_im_inner</span><span class="p">,</span>
                                          <span class="nb">range</span><span class="p">(</span><span class="n">nb_labels_inner</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">mask_inner</span> <span class="o">=</span> <span class="n">sizes_inner</span> <span class="o">&gt;</span> <span class="n">region_threshold</span>
                <span class="n">label_region_inner</span> <span class="o">=</span> <span class="n">mask_inner</span><span class="p">[</span><span class="n">label_im_inner</span><span class="p">]</span>
                <span class="n">region_inner</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">fill_holes</span><span class="p">(</span><span class="n">label_region_inner</span><span class="p">,</span> <span class="o">*</span><span class="n">structures</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

                <span class="n">region_edgeless</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">region_outer</span><span class="p">,</span> <span class="n">region_inner</span><span class="p">)</span>
                <span class="n">region</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">fill_holes</span><span class="p">(</span><span class="n">region_edgeless</span><span class="p">,</span> <span class="o">*</span><span class="n">structures</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">label_im_region</span><span class="p">,</span> <span class="n">nb_labels_region</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">region</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">structures</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">nb_labels_region</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">region_shrunk</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">binary_erosion</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
                    <span class="n">region_diff</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">logical_xor</span><span class="p">(</span><span class="n">region_shrunk</span><span class="p">,</span> <span class="n">region</span><span class="p">)</span>
                    <span class="n">label_im_region_diff</span><span class="p">,</span> <span class="n">nb_labels_region_diff</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span>
                        <span class="n">region_diff</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">structures</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

                    <span class="n">peak_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_peak_neighborhood</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">prob_max</span> <span class="o">*</span> <span class="n">prob_min_ratio</span><span class="p">,</span>
                                                           <span class="n">number_of_peaks</span><span class="o">=</span><span class="n">number_of_peaks</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peak_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="c1"># no peak_neighborhood to calculate dist</span>
                        <span class="n">prob_one</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prob</span> <span class="o">&gt;</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="n">prob_max</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="n">label_im_one</span><span class="p">,</span> <span class="n">nb_labels_one</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">prob_one</span><span class="p">,</span>
                                                                    <span class="n">structure</span><span class="o">=</span><span class="n">structures</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">bec_min</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">prob_one</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">label_im_one</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">peaks_max_index</span> <span class="o">=</span> <span class="p">[</span><span class="n">ndimage</span><span class="o">.</span><span class="n">maximum_position</span><span class="p">(</span><span class="n">peak</span><span class="p">,</span>
                                                                    <span class="n">labels</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">peak</span><span class="p">,</span>
                                                                                    <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">))</span>
                                           <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">peak_list</span>
                                           <span class="p">]</span>
                        <span class="n">max_dists</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">distmat</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">peak_max_index</span><span class="p">)</span>
                                     <span class="k">for</span> <span class="n">peak_max_index</span> <span class="ow">in</span> <span class="n">peaks_max_index</span><span class="p">]</span>
                        <span class="n">max_dists_sum</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">max_dists</span><span class="p">)</span>
                        <span class="n">bec_min_index</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">minimum_position</span><span class="p">(</span><span class="n">max_dists_sum</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">region_diff</span><span class="p">)</span>
                        <span class="n">bec_min</span> <span class="o">=</span> <span class="n">prob</span><span class="p">[</span><span class="n">bec_min_index</span><span class="p">]</span>

                    <span class="n">bec_max</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">region</span><span class="p">)</span>
                    <span class="n">bec_contrast</span> <span class="o">=</span> <span class="p">(</span><span class="n">bec_max</span> <span class="o">-</span> <span class="n">bec_min</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">bec_max</span> <span class="o">+</span> <span class="n">bec_min</span><span class="p">)</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">nb_labels_region</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not connect maxima regions. prob_step: </span><span class="si">{</span><span class="n">prob_step</span><span class="si">}</span><span class="s2"> to high.&quot;</span><span class="p">)</span>
                <span class="c1"># sys.exit(f&quot;Could not connect maxima regions. prob_step: {prob_step} to high.&quot;)</span>

            <span class="n">bec_contrast_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bec_contrast</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bec_contrast_list</span></div>

<div class="viewcode-block" id="SchroedingerMixture.get_polarization"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.get_polarization">[docs]</a>    <span class="k">def</span> <span class="nf">get_polarization</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">filename_steps</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                         <span class="n">steps_format</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">numerator_cut_off</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">divisor_cut_off</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                         <span class="n">frame</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the polarization of a two component mixture: P = density2/density1.</span>

<span class="sd">        :param divisor_cut_off: Cutoff for density1 to prohibit division by 0.</span>

<span class="sd">        :param frame: Frame number of the npz to save to.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">density_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density_list</span><span class="p">()</span>
        <span class="n">val2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">density_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">numerator_cut_off</span><span class="p">,</span> <span class="n">density_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span> 
        <span class="n">val1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">density_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">divisor_cut_off</span><span class="p">,</span> <span class="n">density_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span> 
        <span class="n">polarization</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">val2</span><span class="p">,</span> <span class="n">val1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">val1</span><span class="p">),</span> <span class="n">where</span><span class="o">=</span><span class="n">val1</span><span class="o">!=</span><span class="mi">0</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving Polarization into System.psi_val_list with shape </span><span class="si">{</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">polarization</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
              <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;in: </span><span class="si">{</span><span class="n">input_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_psi_val</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">filename_steps</span><span class="p">,</span> <span class="n">steps_format</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span>
                          <span class="n">arr_list</span><span class="o">=</span><span class="p">[</span><span class="n">polarization</span><span class="p">,</span>
                                    <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">polarization</span><span class="p">))</span>
                                    <span class="p">]</span>
                          <span class="p">)</span>
        <span class="n">polarization_max_index</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">maximum_position</span><span class="p">(</span><span class="n">polarization</span><span class="p">)</span>
        <span class="n">polarization_max</span> <span class="o">=</span> <span class="n">polarization</span><span class="p">[</span><span class="n">polarization_max_index</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">polarization_max</span></div>

<div class="viewcode-block" id="SchroedingerMixture.get_U_dd"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.get_U_dd">[docs]</a>    <span class="k">def</span> <span class="nf">get_U_dd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">density_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates :math:`U_{dd, ij} = \\mathcal{F}^{-1}(\\mathcal{F}(S_{ij} |\psi_{j}|^{2}) V_{k})`</span>
<span class="sd">        with :math: `V_{k} = epsilon_{dd} g (3 (k_z / k)^2 - 1)`,</span>
<span class="sd">        :math: `S_{ij} = exp{-ikM}` and</span>
<span class="sd">        :math: `M_{ij} = stack_shift * \sigma_{x}` with :math: `\sigma_{x}` is the x-Pauli matrix</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pauli_x</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]])</span>
        <span class="n">stack_mat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_shift</span> <span class="o">*</span> <span class="n">pauli_x</span>
        <span class="n">stack_exponent_mat</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij..., klm-&gt;ijklm&quot;</span><span class="p">,</span> <span class="n">stack_mat</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kz_mesh</span><span class="p">)</span>
        <span class="n">stack_shift_op_mat</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span><span class="n">j</span> <span class="o">*</span> <span class="n">stack_exponent_mat</span><span class="p">)</span>

        <span class="n">density_fft_V_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">density_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                                                   <span class="n">cp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">density_list</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
        <span class="n">shifted</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ijklm, jklm-&gt;ijklm&quot;</span><span class="p">,</span> <span class="n">stack_shift_op_mat</span><span class="p">,</span> <span class="n">density_fft_V_k</span><span class="p">)</span>
        <span class="n">U_dd</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">cp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">shifted</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">cp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">shifted</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])],</span>
                         <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">shifted</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">cp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">shifted</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])]])</span>
        
        <span class="k">return</span> <span class="n">U_dd</span></div>

<div class="viewcode-block" id="SchroedingerMixture.get_U_dd_list"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.get_U_dd_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_U_dd_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">density_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="n">U_dd_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">density</span> <span class="ow">in</span> <span class="n">density_list</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">U_dd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span><span class="p">)</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">density</span><span class="p">)))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">({</span><span class="n">e</span><span class="p">})</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">U_dd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">density</span><span class="o">.</span><span class="n">get</span><span class="p">())))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">({</span><span class="n">e</span><span class="p">})</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">U_dd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">density</span><span class="o">.</span><span class="n">get</span><span class="p">())))</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">({</span><span class="n">e</span><span class="p">})</span>


        <span class="k">return</span> <span class="n">U_dd_list</span></div>

<div class="viewcode-block" id="SchroedingerMixture.get_H_pot"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.get_H_pot">[docs]</a>    <span class="k">def</span> <span class="nf">get_H_pot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">terms</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">split_step</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">H_pot</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">*</span> <span class="p">(</span><span class="n">split_step</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span> <span class="o">*</span> <span class="n">terms</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">H_pot</span></div>

<div class="viewcode-block" id="SchroedingerMixture.get_H_pot_exponent_terms"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.get_H_pot_exponent_terms">[docs]</a>    <span class="k">def</span> <span class="nf">get_H_pot_exponent_terms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                 <span class="n">dipol_term</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                 <span class="n">contact_interaction</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                 <span class="n">mu_lhy</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_val</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_dd_factor</span> <span class="o">*</span> <span class="n">dipol_term</span>
                <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">a_s_factor</span> <span class="o">*</span> <span class="n">contact_interaction</span>
                <span class="o">+</span> <span class="n">mu_lhy</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="SchroedingerMixture.split_operator_pot"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.split_operator_pot">[docs]</a>    <span class="k">def</span> <span class="nf">split_operator_pot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split_step</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
            <span class="n">jit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">cupy_used</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
            <span class="n">jit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">density_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density_list</span><span class="p">(</span><span class="n">jit</span><span class="o">=</span><span class="n">jit</span><span class="p">,</span> <span class="n">cupy_used</span><span class="o">=</span><span class="n">cupy_used</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># density_tensor_vec: cp.ndarray = cp.stack(density_list, axis=0)</span>
            <span class="n">density_tensor_vec</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">density_list</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">density_list_np</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">density</span> <span class="ow">in</span> <span class="n">density_list</span><span class="p">:</span>
                <span class="n">density_list_np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">density</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
            <span class="n">density_tensor_vec</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">density_list_np</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># if stack_shift is used U_dd has higher dimensionality (get_U_dd),</span>
        <span class="c1"># but resulting dipol_term_vec the same (else use get_U_dd_list)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stack_shift</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">U_dd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_U_dd</span><span class="p">(</span><span class="n">density_list</span><span class="p">)</span>
            <span class="n">dipol_term_vec</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;ij..., ij...-&gt;i...&quot;</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">a_dd_array</span><span class="p">,</span>
                                                   <span class="n">U_dd</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">U_dd_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_U_dd_list</span><span class="p">(</span><span class="n">density_list</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># U_dd_tensor_vec: cp.ndarray = cp.stack(U_dd_list, axis=0)</span>
                <span class="n">U_dd_tensor_vec</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">U_dd_list</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">U_dd_list_np</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">U_dd</span> <span class="ow">in</span> <span class="n">U_dd_list</span><span class="p">:</span>
                    <span class="n">U_dd_list_np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">U_dd</span><span class="o">.</span><span class="n">get</span><span class="p">())</span>
                <span class="n">U_dd_tensor_vec</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">U_dd_list_np</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dipol_term_vec</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;...ij, j...-&gt;i...&quot;</span><span class="p">,</span>
                                                   <span class="bp">self</span><span class="o">.</span><span class="n">a_dd_array</span><span class="p">,</span>
                                                   <span class="n">U_dd_tensor_vec</span><span class="p">)</span>


        <span class="c1"># update H_pot before use</span>
        <span class="n">contact_interaction_vec</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s2">&quot;...ij, j...-&gt;i...&quot;</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">a_s_array</span><span class="p">,</span>
                                                        <span class="n">density_tensor_vec</span><span class="p">)</span>

        <span class="c1"># contact_interaction_vec = self.arr_tensor_mult(self.a_s_array, density_tensor_vec)</span>
        <span class="c1"># dipol_term_vec = self.arr_tensor_mult(self.a_dd_array, U_dd_tensor_vec)</span>

        <span class="n">mu_lhy_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mu_lhy_list</span><span class="p">(</span><span class="n">density_list</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">contact_interaction</span><span class="p">,</span> <span class="n">dipol_term</span><span class="p">,</span> <span class="n">mu_lhy</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">contact_interaction_vec</span><span class="p">),</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">dipol_term_vec</span><span class="p">),</span>
                <span class="n">mu_lhy_list</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
                <span class="n">tilt_term</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilt</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tilt_term</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">**</span> <span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tilt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span>
 
            <span class="k">if</span> <span class="n">jit</span><span class="p">:</span> 
                <span class="n">term</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">numbas</span><span class="o">.</span><span class="n">get_H_pot_exponent_terms_jit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_val</span><span class="p">,</span>
                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">a_dd_factor</span><span class="p">,</span>
                                                                       <span class="bp">self</span><span class="o">.</span><span class="n">a_s_factor</span><span class="p">,</span>
                                                                       <span class="n">dipol_term</span><span class="p">,</span>
                                                                       <span class="n">contact_interaction</span><span class="p">,</span>
                                                                       <span class="n">mu_lhy</span>
                                                                       <span class="p">)</span>
                <span class="n">term_and_tilt</span> <span class="o">=</span> <span class="n">term</span> <span class="o">+</span> <span class="n">tilt_term</span>
                <span class="n">H_pot_propagator</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">numbas</span><span class="o">.</span><span class="n">get_H_pot_jit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="n">term_and_tilt</span><span class="p">,</span> <span class="n">split_step</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">term</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_H_pot_exponent_terms</span><span class="p">(</span><span class="n">dipol_term</span><span class="p">,</span>
                                                                 <span class="n">contact_interaction</span><span class="p">,</span>
                                                                 <span class="n">mu_lhy</span>
                                                                 <span class="p">)</span>
                <span class="n">term_and_tilt</span> <span class="o">=</span> <span class="n">term</span> <span class="o">+</span> <span class="n">tilt_term</span>
                <span class="n">H_pot_propagator</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_H_pot</span><span class="p">(</span><span class="n">term_and_tilt</span><span class="p">,</span> <span class="n">split_step</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">H_pot_propagator</span><span class="p">)</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">H_pot_propagator</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span></div>

<div class="viewcode-block" id="SchroedingerMixture.split_operator_kin"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.split_operator_kin">[docs]</a>    <span class="k">def</span> <span class="nf">split_operator_kin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># apply H_kin in k-space (transform back and forth)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">)):</span>
            <span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">psi_val</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">H_kin</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">H_kin_list</span><span class="p">):</span>
            <span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">H_kin</span> <span class="o">*</span> <span class="n">psi_val</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">)):</span>
            <span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="n">psi_val</span><span class="p">)</span></div>

<div class="viewcode-block" id="SchroedingerMixture.normalize_psi_val"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.normalize_psi_val">[docs]</a>    <span class="k">def</span> <span class="nf">normalize_psi_val</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">psi_norm_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">psi_val</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">):</span>
            <span class="n">psi_norm_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_norm</span><span class="p">(</span><span class="n">func_val</span><span class="o">=</span><span class="n">psi_val</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi_val_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi_val</span> <span class="o">/</span> <span class="n">cp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">psi_norm_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">psi_norm_list</span></div>

<div class="viewcode-block" id="SchroedingerMixture.time_step"><a class="viewcode-back" href="../../autoapi/supersolids/SchroedingerMixture/index.html#supersolids.SchroedingerMixture.SchroedingerMixture.time_step">[docs]</a>    <span class="k">def</span> <span class="nf">time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numba_used</span><span class="p">,</span> <span class="n">cupy_used</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evolves System according Schrödinger Equations by using the</span>
<span class="sd">        split operator method with the Trotter-Suzuki approximation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># psi_previous_list = []</span>
        <span class="c1"># for previous in self.psi_val_list:</span>
        <span class="c1">#     psi_previous_list.append(deepcopy(previous))</span>
        <span class="c1"># self.get_E_explicit()</span>

        <span class="c1"># adjust dt, to get the time accuracy when needed</span>
        <span class="c1"># self.dt = self.dt_func(self.t, self.dt)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_operator_pot</span><span class="p">(</span><span class="n">split_step</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">jit</span><span class="o">=</span><span class="n">numba_used</span><span class="p">,</span> <span class="n">cupy_used</span><span class="o">=</span><span class="n">cupy_used</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_operator_kin</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_operator_pot</span><span class="p">(</span><span class="n">split_step</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">jit</span><span class="o">=</span><span class="n">numba_used</span><span class="p">,</span> <span class="n">cupy_used</span><span class="o">=</span><span class="n">cupy_used</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="c1"># self.get_mu_explicit(psi_previous_list)</span>
        <span class="c1"># self.get_E_explicit()</span>

        <span class="c1"># for self.imag_time=False, renormalization should be preserved,</span>
        <span class="c1"># but we play safe here (regardless of speedup)</span>
        <span class="c1"># if self.imag_time:</span>
        <span class="n">psi_norm_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">normalize_psi_val</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">psi_norm</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">psi_norm_list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mu_arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">cp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psi_norm</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Daniel Scheiermann.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>