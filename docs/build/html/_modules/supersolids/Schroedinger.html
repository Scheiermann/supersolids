<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>supersolids.Schroedinger &mdash; supersolids 0.1.37rc1 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> supersolids
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Supersolids</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../CONTRIBUTING.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../LICENSE.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">supersolids</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">supersolids.Schroedinger</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for supersolids.Schroedinger</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># author: Daniel Scheiermann</span>
<span class="c1"># email: daniel.scheiermann@itp.uni-hannover.de</span>
<span class="c1"># license: MIT</span>
<span class="c1"># Please feel free to use and modify this, but keep the above information.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Numerical solver for non-linear time-dependent Schrodinger equation.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="kn">import</span> <span class="nn">dill</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span>

<span class="kn">from</span> <span class="nn">supersolids.helper</span> <span class="kn">import</span> <span class="n">constants</span><span class="p">,</span> <span class="n">functions</span><span class="p">,</span> <span class="n">get_path</span><span class="p">,</span> <span class="n">get_version</span>

<span class="n">__GPU_OFF_ENV__</span><span class="p">,</span> <span class="n">__GPU_INDEX_ENV__</span> <span class="o">=</span> <span class="n">get_version</span><span class="o">.</span><span class="n">get_env_variables</span><span class="p">()</span>
<span class="n">cp</span><span class="p">,</span> <span class="n">cupy_used</span><span class="p">,</span> <span class="n">cuda_used</span><span class="p">,</span> <span class="n">numba_used</span> <span class="o">=</span> <span class="n">get_version</span><span class="o">.</span><span class="n">check_cp_nb</span><span class="p">(</span><span class="n">np</span><span class="p">,</span>
                                                               <span class="n">gpu_off</span><span class="o">=</span><span class="n">__GPU_OFF_ENV__</span><span class="p">,</span>
                                                               <span class="n">gpu_index</span><span class="o">=</span><span class="n">__GPU_INDEX_ENV__</span><span class="p">)</span>
<span class="k">if</span> <span class="n">numba_used</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">supersolids.helper.numbas</span> <span class="k">as</span> <span class="nn">numbas</span>

<span class="kn">from</span> <span class="nn">supersolids.SchroedingerSummary</span> <span class="kn">import</span> <span class="n">SchroedingerSummary</span>
<span class="kn">from</span> <span class="nn">supersolids.helper.Resolution</span> <span class="kn">import</span> <span class="n">Resolution</span>
<span class="kn">from</span> <span class="nn">supersolids.helper.Box</span> <span class="kn">import</span> <span class="n">Box</span>
<span class="kn">from</span> <span class="nn">supersolids.helper.get_path</span> <span class="kn">import</span> <span class="n">get_step_index_from_list</span>
<span class="kn">from</span> <span class="nn">supersolids.helper.load_script</span> <span class="kn">import</span> <span class="n">reload_files</span>
<span class="kn">from</span> <span class="nn">supersolids.helper.save_script</span> <span class="kn">import</span> <span class="n">save_script</span>


<div class="viewcode-block" id="Schroedinger"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger">[docs]</a><span class="k">class</span> <span class="nc">Schroedinger</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements a numerical solution of the dimensionless time-dependent</span>
<span class="sd">    non-linear Schroedinger equation for an arbitrary potential:</span>

<span class="sd">    .. math::</span>

<span class="sd">       i \\partial_t \psi = [&amp;-\\frac{1}{2} \\nabla ^2</span>
<span class="sd">                              + \\frac{1}{2} (x^2 + (y \\alpha_y)^2 + (z \\alpha_z)^2) \\\\</span>
<span class="sd">                             &amp;+ g |\psi|^2  + g_{qf} |\psi|^3 + U_{dd}] \psi \\\\</span>

<span class="sd">    With :math:`U_{dd} = \\mathcal{F}^{-1}(\\mathcal{F}(H_{pot} \psi) \epsilon_{dd} g (3 (k_z / k)^2 - 1))`</span>

<span class="sd">    The split operator method with the Trotter-Suzuki approximation</span>
<span class="sd">    for the commutator relation (:math:`H = H_{pot} + H_{kin}`) is used.</span>
<span class="sd">    Hence the accuracy is proportional to :math:`dt^4`</span>
<span class="sd">    The approximation is needed because of the Baker-Campell-Hausdorff formula.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">N</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">MyBox</span><span class="p">:</span> <span class="n">Box</span><span class="p">,</span>
                 <span class="n">Res</span><span class="p">:</span> <span class="n">Resolution</span><span class="p">,</span>
                 <span class="n">max_timesteps</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                 <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                 <span class="n">dt_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">g</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">g_qf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">w_x</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">33.0</span><span class="p">,</span>
                 <span class="n">w_y</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">80.0</span><span class="p">,</span>
                 <span class="n">w_z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mf">167.0</span><span class="p">,</span>
                 <span class="n">a_s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">85.0</span> <span class="o">*</span> <span class="n">constants</span><span class="o">.</span><span class="n">a_0</span><span class="p">,</span>
                 <span class="n">e_dd</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">imag_time</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="n">mu_arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.1</span><span class="p">]),</span>
                 <span class="n">E</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                 <span class="n">psi_0</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">psi_gauss_3d</span><span class="p">,</span>
                 <span class="n">psi_0_noise</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">noise_mesh</span><span class="p">,</span>
                 <span class="n">V</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">v_harmonic_3d</span><span class="p">,</span>
                 <span class="n">V_interaction</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">psi_sol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">thomas_fermi_3d</span><span class="p">,</span>
                 <span class="n">mu_sol</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">mu_3d</span><span class="p">,</span>
                 <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Schrödinger equations for the specified system.</span>

<span class="sd">        :param MyBox: Keyword x0 is minimum in x direction and</span>
<span class="sd">            x1 is maximum. Same for y and z. For 1D just use x0, x1.</span>
<span class="sd">            For 2D x0, x1, y0, y1.</span>
<span class="sd">            For 3D x0, x1, y0, y1, z0, z1.</span>
<span class="sd">            Dimension of simulation is constructed from this dictionary.</span>

<span class="sd">        :param Res: Res</span>
<span class="sd">            Number of grid points in x, y, z direction.</span>
<span class="sd">            Needs to have half size of box dictionary.</span>
<span class="sd">            Keywords x, y, z are used.</span>

<span class="sd">        :param max_timesteps: Maximum timesteps  with length dt for the animation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;SchroedingerSummary_&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">check_ResBox</span><span class="p">(</span><span class="n">Res</span><span class="p">,</span> <span class="n">MyBox</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span><span class="o">.</span><span class="n">dim</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">N</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">N</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_x</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">w_x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_y</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">w_y</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_z</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">w_z</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_s</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">a_s</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_timesteps</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">max_timesteps</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt_func</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="n">dt_func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">g</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g_qf</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">g_qf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_dd</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">e_dd</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">imag_time</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">imag_time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mu_arr</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">mu_arr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">E</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">psi_0</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">psi_0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psi_0_noise</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">psi_0_noise</span>

        <span class="k">if</span> <span class="n">V</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">V</span>

        <span class="k">if</span> <span class="n">V_interaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V_interaction</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">V_interaction</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">V_interaction</span>

        <span class="k">if</span> <span class="n">psi_sol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">psi_sol</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">psi_sol</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol</span> <span class="o">=</span> <span class="n">psi_sol</span>

        <span class="k">if</span> <span class="n">mu_sol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mu_sol</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">mu_sol</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mu_sol</span><span class="p">:</span> <span class="n">Callable</span> <span class="o">=</span> <span class="n">mu_sol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mu_sol</span> <span class="o">=</span> <span class="n">mu_sol</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkx</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">get_grid_helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ky</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dky</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">get_grid_helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kz</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkz</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">get_grid_helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">imag_time</span><span class="p">:</span>
            <span class="c1"># Convention: $e^{-iH} = e^{UH}$</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">U</span><span class="p">:</span> <span class="nb">complex</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="n">j</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">psi_0_noise</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">psi_0_noise</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">V</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_val</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol_val</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">k_squared</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kx</span> <span class="o">**</span> <span class="mf">2.0</span>

            <span class="k">if</span> <span class="n">V_interaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># For no interaction the identity is needed with respect to 2D</span>
                <span class="c1"># * 2D (array with 1.0 everywhere)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">V_interaction</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span> <span class="o">=</span> <span class="n">V_interaction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span> <span class="o">=</span> <span class="n">V_interaction</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">get_meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">psi_0_noise</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">psi_0_noise</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">V</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_val</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol_val</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pos</span><span class="p">)</span>

            <span class="n">kx_mesh</span><span class="p">,</span> <span class="n">ky_mesh</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">get_meshgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ky</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_squared</span> <span class="o">=</span> <span class="n">kx_mesh</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">ky_mesh</span> <span class="o">**</span> <span class="mf">2.0</span>

            <span class="k">if</span> <span class="n">V_interaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># For no interaction the identity is needed with respect to 2D</span>
                <span class="c1"># * 2D (array with 1.0 everywhere)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span> <span class="o">=</span> <span class="n">V_interaction</span><span class="p">(</span><span class="n">kx_mesh</span><span class="p">,</span> <span class="n">ky_mesh</span><span class="p">,</span> <span class="n">g</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="p">)</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_mesh</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">get_grid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span><span class="p">)</span>
            <span class="c1"># if cupy_used:</span>
            <span class="c1">#     x_mesh, y_mesh, z_mesh = cp.asarray(x_mesh), cp.asarray(y_mesh), cp.asarray(z_mesh)</span>

            <span class="k">if</span> <span class="n">psi_0_noise</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_mesh</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">psi_0_noise</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_0</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">,</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">y_mesh</span><span class="p">,</span>
                                                                    <span class="bp">self</span><span class="o">.</span><span class="n">z_mesh</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol_val</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_sol</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_mesh</span><span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_sol_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Norm for psi_sol (trapez integral): &quot;</span>
                              <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">trapez_integral</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_sol_val</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
                <span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="p">,</span> <span class="n">kz</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">),</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ky</span><span class="p">),</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kz</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="p">,</span> <span class="n">kz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kx</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ky</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kz</span>

            <span class="n">kx_mesh</span><span class="p">,</span> <span class="n">ky_mesh</span><span class="p">,</span> <span class="n">kz_mesh</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">kx</span><span class="p">,</span> <span class="n">ky</span><span class="p">,</span> <span class="n">kz</span><span class="p">,</span> <span class="n">indexing</span><span class="o">=</span><span class="s2">&quot;ij&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_squared</span> <span class="o">=</span> <span class="n">kx_mesh</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">ky_mesh</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="n">kz_mesh</span> <span class="o">**</span> <span class="mf">2.0</span>

            <span class="k">if</span> <span class="n">V</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_val</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">V</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mesh</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_mesh</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">V_interaction</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># For no interaction the identity is needed with respect to 2D</span>
                <span class="c1"># * 2D (array with 1.0 everywhere)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">V_interaction</span><span class="p">):</span>
                    <span class="c1"># self.V_k_val = V_interaction(kx_mesh, ky_mesh, kz_mesh, self.z_mesh)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span> <span class="o">=</span> <span class="n">V_interaction</span><span class="p">(</span><span class="n">kx_mesh</span><span class="p">,</span> <span class="n">ky_mesh</span><span class="p">,</span> <span class="n">kz_mesh</span><span class="p">)</span>

        <span class="c1"># here a number (U) is multiplied elementwise with an (1D, 2D or 3D) array (k_squared)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">H_kin</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span> <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_squared</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

<div class="viewcode-block" id="Schroedinger.get_density"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.get_density">[docs]</a>    <span class="k">def</span> <span class="nf">get_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_val</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span>
                    <span class="n">jit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates :math:`|\psi|^p` for 1D, 2D or 3D (depending on self.dim).</span>

<span class="sd">        :param p: Exponent of :math:`|\psi|`. Use p=2.0 for density.</span>

<span class="sd">        :param func_val: Array of function values to get p-norm for.</span>

<span class="sd">        :return: :math:`|\psi|^p`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
            <span class="n">jit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">&lt;=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">func_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="mf">2.0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">jit</span><span class="p">:</span>
                    <span class="n">psi_density</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">numbas</span><span class="o">.</span><span class="n">get_density_jit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">psi_density</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">)</span> <span class="o">**</span> <span class="n">p</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">psi_density</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">)</span> <span class="o">**</span> <span class="n">p</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">psi_density</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">))</span> <span class="o">**</span> <span class="n">p</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">psi_density</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">)</span> <span class="o">**</span> <span class="n">p</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="mf">2.0</span><span class="p">)</span> <span class="ow">and</span> <span class="n">jit</span><span class="p">:</span>
                    <span class="n">psi_density</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">numbas</span><span class="o">.</span><span class="n">get_density_jit</span><span class="p">(</span><span class="n">func_val</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">cupy_used</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">psi_density</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">func_val</span><span class="p">)</span> <span class="o">**</span> <span class="n">p</span>
                        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># cannot compute density in gpu, so compute it in numpy</span>
                                <span class="n">psi_density</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">func_val</span><span class="o">.</span><span class="n">get</span><span class="p">())</span> <span class="o">**</span> <span class="n">p</span>
                                <span class="n">psi_density</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">psi_density</span><span class="p">)</span>
                            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                <span class="c1"># some cuda problem</span>
                                <span class="n">psi_density</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">func_val</span><span class="p">)</span> <span class="o">**</span> <span class="n">p</span>

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">psi_density</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">func_val</span><span class="p">)</span> <span class="o">**</span> <span class="n">p</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Spatial dimension over 3. This is not implemented.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">psi_density</span></div>

<div class="viewcode-block" id="Schroedinger.volume_element"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.volume_element">[docs]</a>    <span class="k">def</span> <span class="nf">volume_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fourier_space</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fourier_space</span><span class="p">:</span>
                <span class="n">dV</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkx</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fourier_space</span><span class="p">:</span>
                <span class="n">dV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dky</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fourier_space</span><span class="p">:</span>
                <span class="n">dV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dky</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dkz</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dz</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Spatial dimension over 3. This is not implemented.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">dV</span></div>

<div class="viewcode-block" id="Schroedinger.sum_dV"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.sum_dV">[docs]</a>    <span class="k">def</span> <span class="nf">sum_dV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">fourier_space</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">dV</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dV</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_element</span><span class="p">(</span><span class="n">fourier_space</span><span class="o">=</span><span class="n">fourier_space</span><span class="p">)</span>

        <span class="n">psi_norm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">func_val</span><span class="p">)</span> <span class="o">*</span> <span class="n">dV</span>

        <span class="k">return</span> <span class="n">psi_norm</span></div>

<div class="viewcode-block" id="Schroedinger.get_norm"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.get_norm">[docs]</a>    <span class="k">def</span> <span class="nf">get_norm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">fourier_space</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates :math:`\int |\psi|^p \\mathrm{dV}` for 1D, 2D or 3D</span>
<span class="sd">        (depending on self.dim). For p=2 it is the 2-norm.</span>

<span class="sd">        :param func: If func is not provided self.get_density(p=p) is used.</span>

<span class="sd">        :param p: Exponent of |\psi|. Use p=2.0 for density.</span>

<span class="sd">        :param fourier_space: Flag to use fourier volume element as dV,</span>
<span class="sd">        so dV = d^3 k.</span>

<span class="sd">        :return: \int |\psi|^p dV</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">func_den</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density</span><span class="p">(</span><span class="n">func_val</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">jit</span><span class="o">=</span><span class="n">numba_used</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fourier_space</span><span class="p">:</span>
            <span class="n">func_norm</span> <span class="o">=</span> <span class="p">((</span><span class="n">cp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="p">))</span>
                         <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_element</span><span class="p">(</span><span class="n">fourier_space</span><span class="o">=</span><span class="n">fourier_space</span><span class="p">))</span>
                         <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
            <span class="n">func_den</span> <span class="o">=</span> <span class="n">func_den</span> <span class="o">*</span> <span class="n">func_norm</span>

        <span class="n">psi_norm</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum_dV</span><span class="p">(</span><span class="n">func_den</span><span class="p">,</span> <span class="n">fourier_space</span><span class="o">=</span><span class="n">fourier_space</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">psi_norm</span></div>

<div class="viewcode-block" id="Schroedinger.trapez_integral"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.trapez_integral">[docs]</a>    <span class="k">def</span> <span class="nf">trapez_integral</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the integral over func_val. If :math:`func_val = |\psi|^p`, then</span>
<span class="sd">        :math:`\int |\psi|^p \\mathrm{dV}` for 1D, 2D or 3D</span>
<span class="sd">        (depending on self.dim) by using the trapez rule.</span>

<span class="sd">        For 1D: :math:`h (f(a) + f(a+h)) / 2`</span>

<span class="sd">        For 2D: :math:`h (f(a, b) + f(a+h, b) + f(a, b+h) + f(a+h, b+h)) / 2`</span>

<span class="sd">        For 3D there are 8 entries in the same manner</span>
<span class="sd">        :math:`(a, b, c) ... (a+h, b+h, c+h)`</span>

<span class="sd">        :param func_val: Grid sampled values of the function to integrate.</span>

<span class="sd">        :return: :math:`\int |\psi|^p \\mathrm{dV}` according to trapez rule</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># TODO: Implement fourier_space (remember fftfreq ordering of func_val)</span>
        <span class="n">dV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">volume_element</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dV</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">func_val</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">func_val</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dV</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">func_val</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                               <span class="o">+</span> <span class="n">func_val</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
                               <span class="o">+</span> <span class="n">func_val</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                               <span class="o">+</span> <span class="n">func_val</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
                               <span class="p">)</span> <span class="o">/</span> <span class="mf">4.0</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">dV</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">func_val</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                               <span class="o">+</span> <span class="n">func_val</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
                               <span class="o">+</span> <span class="n">func_val</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                               <span class="o">+</span> <span class="n">func_val</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
                               <span class="o">+</span> <span class="n">func_val</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                               <span class="o">+</span> <span class="n">func_val</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span>
                               <span class="o">+</span> <span class="n">func_val</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                               <span class="o">+</span> <span class="n">func_val</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span>
                               <span class="p">)</span> <span class="o">/</span> <span class="mf">8.0</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Trapez integral not implemented for dimension </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="si">}</span><span class="s2">, &quot;</span>
                     <span class="s2">&quot;choose dimension smaller than 4.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Schroedinger.get_r2"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.get_r2">[docs]</a>    <span class="k">def</span> <span class="nf">get_r2</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">r2</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span> <span class="o">**</span> <span class="mf">2.0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mesh</span> <span class="o">**</span> <span class="mf">2.0</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mesh</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">z_mesh</span> <span class="o">**</span> <span class="mf">2.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spatial dimension </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="si">}</span><span class="s2"> is over 3. This is not implemented.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">r2</span></div>

<div class="viewcode-block" id="Schroedinger.get_mesh_list"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.get_mesh_list">[docs]</a>    <span class="k">def</span> <span class="nf">get_mesh_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">Mx0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mx1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">My0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">My1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">Mz0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mz1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_default</span><span class="p">(</span><span class="n">Mx0</span><span class="p">,</span> <span class="n">Mx1</span><span class="p">,</span> <span class="n">My0</span><span class="p">,</span> <span class="n">My1</span><span class="p">,</span> <span class="n">Mz0</span><span class="p">,</span> <span class="n">Mz1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">r</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_mesh</span><span class="p">[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">]]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">r</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_mesh</span><span class="p">[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">:</span><span class="n">z1</span><span class="p">],</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">y_mesh</span><span class="p">[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">:</span><span class="n">z1</span><span class="p">],</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">z_mesh</span><span class="p">[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">:</span><span class="n">z1</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Spatial dimension over 3. This is not implemented.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">r</span></div>

<div class="viewcode-block" id="Schroedinger.sum_along"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.sum_along">[docs]</a>    <span class="k">def</span> <span class="nf">sum_along</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">l_0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">l_0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># x harmonic oscillator length</span>
            <span class="n">l_0</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">constants</span><span class="o">.</span><span class="n">hbar</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">m_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_x</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">psi_axis_sum</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">func_val</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dx</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">l_0</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">psi_axis_sum</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">func_val</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dy</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">l_0</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">psi_axis_sum</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">func_val</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dz</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">l_0</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span>

        <span class="n">psi_axis_sum_3d</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">func_val</span><span class="p">))</span>
        <span class="n">psi_axis_sum_3d</span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">psi_axis_sum</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">psi_axis_sum_3d</span></div>

<div class="viewcode-block" id="Schroedinger.get_peaks_along"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.get_peaks_along">[docs]</a>    <span class="k">def</span> <span class="nf">get_peaks_along</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
                                                                            <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]]:</span>
        <span class="n">prob</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span>
        <span class="n">res_x_middle</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">res_y_middle</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">res_z_middle</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">z</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">peaks_indices</span><span class="p">,</span> <span class="n">properties</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">prob</span><span class="p">[:,</span> <span class="n">res_y_middle</span><span class="p">,</span> <span class="n">res_z_middle</span><span class="p">],</span>
                                                                <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">peaks_indices</span><span class="p">,</span> <span class="n">properties</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="n">res_x_middle</span><span class="p">,</span> <span class="p">:,</span> <span class="n">res_z_middle</span><span class="p">],</span>
                                                                <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">peaks_indices</span><span class="p">,</span> <span class="n">properties</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">find_peaks</span><span class="p">(</span><span class="n">prob</span><span class="p">[</span><span class="n">res_x_middle</span><span class="p">,</span> <span class="n">res_y_middle</span><span class="p">,</span> <span class="p">:],</span>
                                                                <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No such axis ()</span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s2">. Choose 0, 1 or 2 for axis x, y or z.&quot;</span><span class="p">)</span>

        <span class="c1"># get the highest peaks in a sorted fashion (the n biggest, where n is number_of_peaks)</span>
        <span class="n">peaks_height</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="n">properties</span><span class="p">[</span><span class="s1">&#39;peak_heights&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">peaks_indices</span><span class="p">,</span> <span class="n">peaks_height</span></div>

<div class="viewcode-block" id="Schroedinger.get_peak_positions_along"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.get_peak_positions_along">[docs]</a>    <span class="k">def</span> <span class="nf">get_peak_positions_along</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                 <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                 <span class="n">height</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
                                 <span class="n">number_of_peaks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">peaks_indices</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_peaks_along</span><span class="p">(</span><span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span><span class="o">.</span><span class="n">lengths</span><span class="p">()[</span><span class="n">axis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">peaks_indices</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span><span class="o">.</span><span class="n">x0</span>
        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span><span class="o">.</span><span class="n">lengths</span><span class="p">()[</span><span class="n">axis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">peaks_indices</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">y</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span><span class="o">.</span><span class="n">y0</span>
        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span><span class="o">.</span><span class="n">lengths</span><span class="p">()[</span><span class="n">axis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">peaks_indices</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span><span class="o">.</span><span class="n">z0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No such axis. Choose 0, 1 or 2 for axis x, y or z.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">positions</span></div>

<div class="viewcode-block" id="Schroedinger.get_peak_distances_along"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.get_peak_distances_along">[docs]</a>    <span class="k">def</span> <span class="nf">get_peak_distances_along</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the distances between the peaks in terms of box units.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">peaks_indices</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_peaks_along</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">)</span>
        <span class="n">distances_indices</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">peaks_indices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span><span class="o">.</span><span class="n">lengths</span><span class="p">()[</span><span class="n">axis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">distances_indices</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span><span class="o">.</span><span class="n">lengths</span><span class="p">()[</span><span class="n">axis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">distances_indices</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">y</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">distances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Box</span><span class="o">.</span><span class="n">lengths</span><span class="p">()[</span><span class="n">axis</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">distances_indices</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No such axis (</span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s2">). Choose 0, 1 or 2 for axis x, y or z.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">distances</span></div>

<div class="viewcode-block" id="Schroedinger.get_peak_neighborhood_along"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.get_peak_neighborhood_along">[docs]</a>    <span class="k">def</span> <span class="nf">get_peak_neighborhood_along</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">height</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">,</span>
                                    <span class="n">number_of_peaks</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
                                    <span class="n">fraction</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
                                    <span class="n">peak_distances_cutoff</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the neighborhood of the peaks,</span>
<span class="sd">        which has at least the given fraction of the maximum probability :math:`|\psi|^2`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">peaks_indices</span><span class="p">,</span> <span class="n">peaks_height</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_peaks_along</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="n">height</span><span class="p">)</span>
        <span class="n">peaks_sorted_indices</span><span class="p">,</span> <span class="n">peaks_sorted_height</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">peaks_sort_along</span><span class="p">(</span><span class="n">peaks_indices</span><span class="p">,</span>
                                                                               <span class="n">peaks_height</span><span class="p">,</span>
                                                                               <span class="n">number_of_peaks</span><span class="p">,</span>
                                                                               <span class="n">axis</span><span class="p">,</span>
                                                                               <span class="p">)</span>

        <span class="n">distances_indices</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">peaks_sorted_indices</span><span class="o">.</span><span class="n">T</span><span class="p">))</span>
        <span class="c1"># extend one element at beginning and end, according to first/last element</span>
        <span class="n">distances_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">distances_indices</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="s1">&#39;edge&#39;</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">distances_indices</span><span class="p">))]</span>

        <span class="n">prob_min</span> <span class="o">=</span> <span class="n">fraction</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">peaks_sorted_height</span><span class="p">)</span>
        <span class="n">prob</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span>
        <span class="n">bool_grid</span> <span class="o">=</span> <span class="p">(</span><span class="n">prob_min</span> <span class="o">&lt;=</span> <span class="n">prob</span><span class="p">)</span>
        <span class="n">bool_grid_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">peak_index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">peaks_sorted_indices</span><span class="p">):</span>
            <span class="c1"># peak_radius = peak_distances_cutoff * cp.abs(distances_indices)[i]</span>
            <span class="n">peak_radius</span> <span class="o">=</span> <span class="n">peak_distances_cutoff</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">distances_indices</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:])</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bound_left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">peak_index</span> <span class="o">-</span> <span class="n">peak_radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">bound_right</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">peak_index</span> <span class="o">+</span> <span class="n">peak_radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">x</span><span class="p">))</span>
                <span class="n">bool_grid_sliced</span> <span class="o">=</span> <span class="n">bool_grid</span><span class="p">[</span><span class="n">bound_left</span><span class="p">:</span><span class="n">bound_right</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">z</span><span class="p">]</span>
                <span class="n">pad_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="n">bound_right</span>
                <span class="n">bool_grid_padded</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">bool_grid_sliced</span><span class="p">,</span> <span class="p">((</span><span class="n">bound_left</span><span class="p">,</span> <span class="n">pad_right</span><span class="p">),</span>
                                                             <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                                             <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">bound_left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">peak_index</span> <span class="o">-</span> <span class="n">peak_radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">bound_right</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">peak_index</span> <span class="o">+</span> <span class="n">peak_radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">y</span><span class="p">))</span>
                <span class="n">bool_grid_sliced</span> <span class="o">=</span> <span class="n">bool_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">bound_left</span><span class="p">:</span><span class="n">bound_right</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">z</span><span class="p">]</span>
                <span class="n">pad_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">bound_right</span>
                <span class="n">bool_grid_padded</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">bool_grid_sliced</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                                             <span class="p">(</span><span class="n">bound_left</span><span class="p">,</span> <span class="n">pad_right</span><span class="p">),</span>
                                                             <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">axis</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">bound_left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">peak_index</span> <span class="o">-</span> <span class="n">peak_radius</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">bound_right</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">peak_index</span> <span class="o">+</span> <span class="n">peak_radius</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">z</span><span class="p">))</span>
                <span class="n">bool_grid_sliced</span> <span class="o">=</span> <span class="n">bool_grid</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">bound_left</span><span class="p">:</span><span class="n">bound_right</span><span class="p">]</span>
                <span class="n">pad_right</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="n">bound_right</span>
                <span class="n">bool_grid_padded</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">bool_grid_sliced</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                                             <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                                             <span class="p">(</span><span class="n">bound_left</span><span class="p">,</span> <span class="n">pad_right</span><span class="p">)),</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="s2">&quot;Choose axis from [0, 1, 2] or use get_peak_neighborhood.&quot;</span><span class="p">)</span>

            <span class="n">bool_grid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bool_grid_padded</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bool_grid_list</span></div>

<div class="viewcode-block" id="Schroedinger.get_peak_neighborhood"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.get_peak_neighborhood">[docs]</a>    <span class="k">def</span> <span class="nf">get_peak_neighborhood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prob</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">prob_min</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                              <span class="n">number_of_peaks</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the neighborhood of the peaks,</span>
<span class="sd">        which has at least the given fraction of the maximum probability :math:`|\psi|^2`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">peaks_indices</span><span class="p">,</span> <span class="n">peaks_height</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">get_peaks</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span>
        <span class="n">peaks_sorted_indices</span><span class="p">,</span> <span class="n">peaks_sorted_height</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">peaks_sort</span><span class="p">(</span><span class="n">peaks_indices</span><span class="p">,</span>
                                                                         <span class="n">peaks_height</span><span class="p">,</span>
                                                                         <span class="n">number_of_peaks</span><span class="p">)</span>

        <span class="n">bool_grid_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">peak_index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">peaks_sorted_indices</span><span class="p">):</span>
            <span class="n">prob_droplets</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">prob</span> <span class="o">&gt;</span> <span class="n">prob_min</span><span class="p">,</span> <span class="n">prob</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">single_droplet</span><span class="p">,</span> <span class="n">edges</span> <span class="o">=</span> <span class="n">functions</span><span class="o">.</span><span class="n">extract_droplet</span><span class="p">(</span><span class="n">prob_droplets</span><span class="p">,</span>
                                                              <span class="n">peaks_sorted_indices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

            <span class="n">pad_width</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">res_axis</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">z</span><span class="p">])):</span>
                <span class="n">edge_left</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">edges</span><span class="p">)[</span><span class="n">j</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">edge_right</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">edges</span><span class="p">)[</span><span class="n">j</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">pad_right</span> <span class="o">=</span> <span class="n">res_axis</span> <span class="o">-</span> <span class="n">edge_right</span>
                <span class="n">pad_width</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">edge_left</span><span class="p">,</span> <span class="n">pad_right</span><span class="p">))</span>
            <span class="n">bool_grid_padded</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">single_droplet</span><span class="p">,</span> <span class="n">pad_width</span><span class="p">,</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>

            <span class="n">bool_grid_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bool_grid_padded</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bool_grid_list</span></div>

<div class="viewcode-block" id="Schroedinger.get_N_in_droplets"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.get_N_in_droplets">[docs]</a>    <span class="k">def</span> <span class="nf">get_N_in_droplets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prob_min</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">number_of_peaks</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The first number_of_peaks entries are the number of particles in droplets</span>
<span class="sd">        (defined by :math:`|\psi|^2 &gt; \\mathrm{prob_min}`) on the x-axis from left to right.</span>
<span class="sd">        The last entry is the sum of particles of those droplets.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">bool_grid_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_peak_neighborhood</span><span class="p">(</span>
            <span class="n">prob</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">,</span>
            <span class="n">prob_min</span><span class="o">=</span><span class="n">prob_min</span><span class="p">,</span>
            <span class="n">number_of_peaks</span><span class="o">=</span><span class="n">number_of_peaks</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">N_in_droplets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">number_of_peaks</span><span class="p">):</span>
            <span class="n">psi_val_droplets</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bool_grid_list</span><span class="p">[</span><span class="n">k</span><span class="p">],</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">,</span>
                                        <span class="n">cp</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">)))</span>

            <span class="n">droplets_density</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trapez_integral</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">psi_val_droplets</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span>
            <span class="n">N_in_droplets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">*</span> <span class="n">droplets_density</span><span class="p">)</span>

        <span class="n">N_in_droplets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">N_in_droplets</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">N_in_droplets</span></div>

<div class="viewcode-block" id="Schroedinger.slice_default"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.slice_default">[docs]</a>    <span class="k">def</span> <span class="nf">slice_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">Mx0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mx1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">My0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">My1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">Mz0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mz1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span>
                                                                                     <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Mx0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Mx1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Mx0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">Mx0</span> <span class="ow">or</span> <span class="n">Mx1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">x</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: Slice indices (</span><span class="si">{</span><span class="n">Mx0</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">Mx1</span><span class="si">}</span><span class="s2">) for x out of bound. &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;Bounds are (0, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">x</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">Mx0</span>
                <span class="n">x1</span> <span class="o">=</span> <span class="n">Mx1</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">My0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">My1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">y1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">My0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">My0</span> <span class="ow">or</span> <span class="n">My1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">y</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: Slice indices (</span><span class="si">{</span><span class="n">My0</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">My1</span><span class="si">}</span><span class="s2">) for y out of bound. &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;Bounds are (0, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">y</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">y0</span> <span class="o">=</span> <span class="n">My0</span>
                <span class="n">y1</span> <span class="o">=</span> <span class="n">My1</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">Mz0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">Mz1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">z0</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">z</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">Mz0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">((</span><span class="n">Mz0</span> <span class="ow">or</span> <span class="n">Mz1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">z</span><span class="p">):</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ERROR: Slice indices (</span><span class="si">{</span><span class="n">Mz0</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">Mz1</span><span class="si">}</span><span class="s2">) for z out of bound. &quot;</span>
                         <span class="sa">f</span><span class="s2">&quot;Bounds are (0, </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">Res</span><span class="o">.</span><span class="n">z</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">z0</span> <span class="o">=</span> <span class="n">Mz0</span>
                <span class="n">z1</span> <span class="o">=</span> <span class="n">Mz1</span>

        <span class="k">return</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span></div>

<div class="viewcode-block" id="Schroedinger.get_center_of_mass"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.get_center_of_mass">[docs]</a>    <span class="k">def</span> <span class="nf">get_center_of_mass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                           <span class="n">Mx0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mx1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">My0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">My1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                           <span class="n">Mz0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mz1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the center of mass of the System.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_default</span><span class="p">(</span><span class="n">Mx0</span><span class="p">,</span> <span class="n">Mx1</span><span class="p">,</span> <span class="n">My0</span><span class="p">,</span> <span class="n">My1</span><span class="p">,</span> <span class="n">Mz0</span><span class="p">,</span> <span class="n">Mz1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">numba_used</span><span class="p">:</span>
            <span class="n">prob</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">numbas</span><span class="o">.</span><span class="n">get_density_jit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">:</span><span class="n">z1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prob</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">jit</span><span class="o">=</span><span class="n">numba_used</span><span class="p">)[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">:</span><span class="n">z1</span><span class="p">]</span>

        <span class="n">r</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mesh_list</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span><span class="p">)</span>
        <span class="n">center_of_mass_along_axis</span> <span class="o">=</span> <span class="p">[</span><span class="n">prob</span> <span class="o">*</span> <span class="n">r_i</span> <span class="k">for</span> <span class="n">r_i</span> <span class="ow">in</span> <span class="n">r</span><span class="p">]</span>
        <span class="n">com</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">trapez_integral</span><span class="p">(</span><span class="n">com_along_axis</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">trapez_integral</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span> <span class="k">for</span> <span class="n">com_along_axis</span>
               <span class="ow">in</span>
               <span class="n">center_of_mass_along_axis</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">com</span></div>

<div class="viewcode-block" id="Schroedinger.get_parity"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.get_parity">[docs]</a>    <span class="k">def</span> <span class="nf">get_parity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                   <span class="n">axis</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
                   <span class="n">Mx0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mx1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">My0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">My1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">Mz0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mz1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>

        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_default</span><span class="p">(</span><span class="n">Mx0</span><span class="p">,</span> <span class="n">Mx1</span><span class="p">,</span> <span class="n">My0</span><span class="p">,</span> <span class="n">My1</span><span class="p">,</span> <span class="n">Mz0</span><span class="p">,</span> <span class="n">Mz1</span><span class="p">)</span>
        <span class="n">psi_under0</span><span class="p">,</span> <span class="n">psi_over0</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">axis</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]:</span>
            <span class="n">psi_over0_reversed</span> <span class="o">=</span> <span class="n">psi_over0</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No such axis (</span><span class="si">{</span><span class="n">axis</span><span class="si">}</span><span class="s2">). Choose 0, 1 or 2 for axis x, y or z.&quot;</span><span class="p">)</span>

        <span class="n">parity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trapez_integral</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
            <span class="n">psi_under0</span><span class="p">[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">:</span><span class="n">z1</span><span class="p">]</span> <span class="o">-</span> <span class="n">psi_over0_reversed</span><span class="p">[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">:</span><span class="n">z1</span><span class="p">])</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">parity</span></div>

<div class="viewcode-block" id="Schroedinger.get_phase_var_neighborhood"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.get_phase_var_neighborhood">[docs]</a>    <span class="k">def</span> <span class="nf">get_phase_var_neighborhood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prob_min</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">number_of_peaks</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the variance of the phase of the System.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prob</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">)</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">,</span>
        <span class="n">bool_grid_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_peak_neighborhood</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">prob_min</span><span class="p">,</span> <span class="n">number_of_peaks</span><span class="p">)</span>
        <span class="n">bool_grid</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">bool_grid_list</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">bool_grid_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_norm</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">numba_used</span><span class="p">:</span>
            <span class="n">prob</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">bool_grid</span> <span class="o">*</span> <span class="n">numbas</span><span class="o">.</span><span class="n">get_density_jit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prob</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">bool_grid</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">jit</span><span class="o">=</span><span class="n">numba_used</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span>

        <span class="n">psi_val_bool_grid</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">bool_grid</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">psi_val_bool_grid</span><span class="p">)</span>
        <span class="n">angle_cos</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trapez_integral</span><span class="p">(</span><span class="n">prob</span> <span class="o">*</span> <span class="n">angle_cos</span><span class="p">)</span>
        <span class="n">phase2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trapez_integral</span><span class="p">(</span><span class="n">prob</span> <span class="o">*</span> <span class="n">angle_cos</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="n">phase_var</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">phase2</span> <span class="o">-</span> <span class="n">phase</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">phase_var</span></div>

<div class="viewcode-block" id="Schroedinger.get_phase_var"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.get_phase_var">[docs]</a>    <span class="k">def</span> <span class="nf">get_phase_var</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">Mx0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mx1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">My0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">My1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                      <span class="n">Mz0</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Mz1</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the variance of the phase of the System by cos(phi).</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">,</span> <span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">,</span> <span class="n">z1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_default</span><span class="p">(</span><span class="n">Mx0</span><span class="p">,</span> <span class="n">Mx1</span><span class="p">,</span> <span class="n">My0</span><span class="p">,</span> <span class="n">My1</span><span class="p">,</span> <span class="n">Mz0</span><span class="p">,</span> <span class="n">Mz1</span><span class="p">)</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_norm</span><span class="p">(</span><span class="n">func_val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">:</span><span class="n">z1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">numba_used</span><span class="p">:</span>
            <span class="n">prob_cropped</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">numbas</span><span class="o">.</span><span class="n">get_density_jit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">,</span>
                                                              <span class="n">p</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">:</span><span class="n">z1</span><span class="p">]</span> <span class="o">/</span> <span class="n">norm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prob_cropped</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                                                        <span class="n">jit</span><span class="o">=</span><span class="n">numba_used</span><span class="p">)[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">:</span><span class="n">z1</span><span class="p">]</span> <span class="o">/</span> <span class="n">norm</span>

        <span class="n">psi_val_cropped</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">[</span><span class="n">x0</span><span class="p">:</span><span class="n">x1</span><span class="p">,</span> <span class="n">y0</span><span class="p">:</span><span class="n">y1</span><span class="p">,</span> <span class="n">z0</span><span class="p">:</span><span class="n">z1</span><span class="p">]</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">psi_val_cropped</span><span class="p">)</span>
        <span class="n">angle_cos</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angle</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="n">phase</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trapez_integral</span><span class="p">(</span><span class="n">prob_cropped</span> <span class="o">*</span> <span class="n">angle_cos</span><span class="p">)</span>
        <span class="n">phase2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trapez_integral</span><span class="p">(</span><span class="n">prob_cropped</span> <span class="o">*</span> <span class="n">angle_cos</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">)</span>

        <span class="n">phase_var</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">phase2</span> <span class="o">-</span> <span class="n">phase</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">phase_var</span></div>

<div class="viewcode-block" id="Schroedinger.split_operator_pot"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.split_operator_pot">[docs]</a>    <span class="k">def</span> <span class="nf">split_operator_pot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split_step</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">jit</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">jit</span><span class="p">:</span>
            <span class="n">psi_2</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">numbas</span><span class="o">.</span><span class="n">get_density_jit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="n">psi_3</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">numbas</span><span class="o">.</span><span class="n">get_density_jit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">psi_2</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">jit</span><span class="o">=</span><span class="n">jit</span><span class="p">)</span>
            <span class="n">psi_3</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">jit</span><span class="o">=</span><span class="n">jit</span><span class="p">)</span>
        <span class="n">U_dd</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">psi_2</span><span class="p">))</span>

        <span class="c1"># update H_pot before use</span>
        <span class="n">H_pot</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_H_pot</span><span class="p">(</span><span class="n">psi_2</span><span class="p">,</span> <span class="n">psi_3</span><span class="p">,</span> <span class="n">U_dd</span><span class="p">)</span>

        <span class="c1"># multiply element-wise the (1D, 2D or 3D) arrays with each other</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">H_pot</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span></div>

<div class="viewcode-block" id="Schroedinger.split_operator_kin"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.split_operator_kin">[docs]</a>    <span class="k">def</span> <span class="nf">split_operator_kin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">)</span>
        <span class="c1"># H_kin is just dependent on U and the grid-points, which are constants,</span>
        <span class="c1"># so it does not need to be recalculated</span>
        <span class="c1"># multiply element-wise the (1D, 2D or 3D) array (H_kin) with psi_val</span>
        <span class="c1"># (1D, 2D or 3D)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H_kin</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">)</span></div>

<div class="viewcode-block" id="Schroedinger.get_H_pot"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.get_H_pot">[docs]</a>    <span class="k">def</span> <span class="nf">get_H_pot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">psi_2</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">psi_3</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">U_dd</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="n">H_pot</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">U</span>
                                   <span class="o">*</span> <span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
                                   <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">V_val</span>
                                      <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">psi_2</span>
                                      <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_qf</span> <span class="o">*</span> <span class="n">psi_3</span>
                                      <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_dd</span> <span class="o">*</span> <span class="n">U_dd</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">H_pot</span></div>

<div class="viewcode-block" id="Schroedinger.time_step"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.time_step">[docs]</a>    <span class="k">def</span> <span class="nf">time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numba_used</span><span class="p">,</span> <span class="n">cupy_used</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evolves System according Schrödinger Equations by using the</span>
<span class="sd">        split operator method with the Trotter-Suzuki approximation.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># adjust dt, to get the time accuracy when needed</span>
        <span class="c1"># self.dt = self.dt_func(self.t, self.dt)</span>

        <span class="c1"># Calculate the interaction by applying it to the psi_2 in k-space</span>
        <span class="c1"># (transform back and forth)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_operator_pot</span><span class="p">(</span><span class="n">split_step</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">jit</span><span class="o">=</span><span class="n">numba_used</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_operator_kin</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_operator_pot</span><span class="p">(</span><span class="n">split_step</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">jit</span><span class="o">=</span><span class="n">numba_used</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>

        <span class="n">psi_norm_after_evolution</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_norm</span><span class="p">()</span>

        <span class="c1"># for self.imag_time=False, renormalization should be preserved,</span>
        <span class="c1"># but we play safe here (regardless of speedup)</span>
        <span class="c1"># if self.imag_time:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span> <span class="o">/</span> <span class="n">cp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">psi_norm_after_evolution</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mu_arr</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">cp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">psi_norm_after_evolution</span><span class="p">)</span>
                                <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)])</span></div>

<div class="viewcode-block" id="Schroedinger.get_E"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.get_E">[docs]</a>    <span class="k">def</span> <span class="nf">get_E</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">V_interaction</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">numba_used</span><span class="p">:</span>
                <span class="n">psi_2</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">numbas</span><span class="o">.</span><span class="n">get_density_jit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">psi_2</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_density</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">jit</span><span class="o">=</span><span class="n">numba_used</span><span class="p">)</span>

            <span class="n">E_U_dd</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">cp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">**</span> <span class="mf">3.0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">sum_dV</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">V_k_val</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="n">psi_2</span><span class="p">))</span> <span class="o">**</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">fourier_space</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">E_U_dd</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">psi_quadratic_int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_norm</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">4.0</span><span class="p">)</span>
        <span class="n">psi_quintic_int</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_norm</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">5.0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">E</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu_arr</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">*</span> <span class="n">psi_quadratic_int</span>
                  <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">E_U_dd</span>
                  <span class="o">-</span> <span class="p">(</span><span class="mf">3.0</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">g_qf</span> <span class="o">*</span> <span class="n">psi_quintic_int</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">E</span></div>

<div class="viewcode-block" id="Schroedinger.get_E_kin"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.get_E_kin">[docs]</a>    <span class="k">def</span> <span class="nf">get_E_kin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="n">psi_val_k</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">)</span>
        <span class="n">psi_norm_k</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_norm</span><span class="p">(</span><span class="n">psi_val_k</span><span class="p">,</span> <span class="n">fourier_space</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">psi_val_k</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">psi_val_k</span> <span class="o">/</span> <span class="n">cp</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">psi_norm_k</span><span class="p">)</span>
        <span class="n">E_kin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_norm</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_squared</span> <span class="o">*</span> <span class="n">psi_val_k</span><span class="p">,</span> <span class="n">fourier_space</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">E_kin</span></div>

<div class="viewcode-block" id="Schroedinger.use_summary"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.use_summary">[docs]</a>    <span class="k">def</span> <span class="nf">use_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">summary_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">SchroedingerSummary</span><span class="p">,</span>
                                                                       <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
        <span class="n">Summary</span><span class="p">:</span> <span class="n">SchroedingerSummary</span> <span class="o">=</span> <span class="n">SchroedingerSummary</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Summary</span><span class="p">,</span> <span class="n">summary_name</span></div>

<div class="viewcode-block" id="Schroedinger.load_summary"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.load_summary">[docs]</a>    <span class="k">def</span> <span class="nf">load_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">steps_format</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                     <span class="n">summary_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;SchroedingerSummary_&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;Schroedinger&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">summary_name</span><span class="p">:</span>
            <span class="n">system_summary_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span>
                                                       <span class="n">summary_name</span> <span class="o">+</span> <span class="n">steps_format</span> <span class="o">%</span> <span class="n">frame</span> <span class="o">+</span> <span class="s2">&quot;.pkl&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># needed because old versions had no self.name</span>
                <span class="n">system_summary_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">steps_format</span> <span class="o">%</span> <span class="n">frame</span> <span class="o">+</span> <span class="s2">&quot;.pkl&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">system_summary_path</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;system_summary_path set None.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># load SchroedingerSummary</span>
            <span class="k">if</span> <span class="n">system_summary_path</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">system_summary_path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">SystemSummary</span><span class="p">:</span> <span class="n">SchroedingerSummary</span> <span class="o">=</span> <span class="n">dill</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">SystemSummary</span><span class="o">.</span><span class="n">copy_to</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;system_summary_path is None.&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">system_summary_path</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="Schroedinger.save_psi_val"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.save_psi_val">[docs]</a>    <span class="k">def</span> <span class="nf">save_psi_val</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">filename_steps</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                     <span class="n">steps_format</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">filename_steps</span> <span class="o">+</span> <span class="n">steps_format</span> <span class="o">%</span> <span class="n">frame</span> <span class="o">+</span> <span class="s2">&quot;.npz&quot;</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">g</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">savez_compressed</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">psi_val</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">psi_val</span><span class="p">)</span></div>

<div class="viewcode-block" id="Schroedinger.save_summary"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.save_summary">[docs]</a>    <span class="k">def</span> <span class="nf">save_summary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">SystemSummary</span><span class="p">,</span> <span class="n">input_path</span><span class="p">:</span> <span class="n">Path</span><span class="p">,</span> <span class="n">steps_format</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">frame</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="n">steps_format</span> <span class="o">%</span> <span class="n">frame</span> <span class="o">+</span> <span class="s2">&quot;.pkl&quot;</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">dill</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">SystemSummary</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span></div>


<div class="viewcode-block" id="Schroedinger.simulate_raw"><a class="viewcode-back" href="../../autoapi/supersolids/Schroedinger/index.html#supersolids.Schroedinger.Schroedinger.simulate_raw">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">accuracy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span>
                     <span class="n">dir_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">home</span><span class="p">()</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;supersolids&quot;</span><span class="p">,</span> <span class="s2">&quot;results&quot;</span><span class="p">),</span>
                     <span class="n">dir_name_load</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                     <span class="n">dir_name_result</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                     <span class="n">filename_schroedinger</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;schroedinger.pkl&quot;</span><span class="p">,</span>
                     <span class="n">filename_steps</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;step_&quot;</span><span class="p">,</span>
                     <span class="n">steps_format</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">%07d</span><span class="s2">&quot;</span><span class="p">,</span>
                     <span class="n">steps_per_npz</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                     <span class="n">steps_property</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
                     <span class="n">frame_start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="n">script_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;script&quot;</span><span class="p">,</span>
                     <span class="n">script_args</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
                     <span class="n">script_number_regex</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span><span class="p">,</span>
                     <span class="n">script_extensions</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">script_extensions_index</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="p">):</span>
        <span class="k">if</span> <span class="n">script_extensions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">script_extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;.pkl&quot;</span><span class="p">,</span> <span class="s2">&quot;.txt&quot;</span><span class="p">]</span>
            <span class="n">script_extensions_index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy goal: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Create a results dir, if there is none</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dir_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">dir_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Initialize mu_rel</span>
        <span class="n">mu_rel</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu_arr</span>

        <span class="k">if</span> <span class="n">dir_name_result</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">_</span><span class="p">,</span> <span class="n">last_index</span><span class="p">,</span> <span class="n">dir_name</span><span class="p">,</span> <span class="n">counting_format</span> <span class="o">=</span> <span class="n">get_path</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">last_index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">last_index</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">input_path</span><span class="p">:</span> <span class="n">Path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">dir_name</span> <span class="o">+</span> <span class="n">counting_format</span> <span class="o">%</span> <span class="p">(</span><span class="n">last_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">input_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">dir_name_result</span><span class="p">)</span>

        <span class="c1"># Create a movie dir, if there is none</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">input_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">input_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># per default index 0 takes list with pkl</span>
        <span class="n">script_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">reload_files</span><span class="p">(</span>
                                        <span class="n">dir_path</span><span class="p">,</span> <span class="n">dir_name_load</span><span class="p">,</span> <span class="n">input_path</span><span class="p">,</span> <span class="n">script_name</span><span class="p">,</span>
                                        <span class="n">script_number_regex</span><span class="o">=</span><span class="n">script_number_regex</span><span class="p">,</span>
                                        <span class="n">script_extensions</span><span class="o">=</span><span class="n">script_extensions</span>
                                        <span class="p">)[</span><span class="n">script_extensions_index</span><span class="p">]</span>
                                   <span class="p">]</span>

        <span class="n">script_count_old</span> <span class="o">=</span> <span class="n">get_step_index_from_list</span><span class="p">(</span>
            <span class="n">script_list</span><span class="p">,</span>
            <span class="n">filename_prefix</span><span class="o">=</span><span class="n">script_name</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span><span class="p">,</span>
            <span class="n">file_pattern</span><span class="o">=</span><span class="n">script_extensions</span><span class="p">[</span><span class="n">script_extensions_index</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># per default index 0 takes list with pkl</span>
        <span class="n">filename_schroedinger_prefix</span> <span class="o">=</span> <span class="n">filename_schroedinger</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">schroedinger_list</span> <span class="o">=</span> <span class="n">reload_files</span><span class="p">(</span>
            <span class="n">dir_path</span><span class="p">,</span> <span class="n">dir_name_load</span><span class="p">,</span> <span class="n">input_path</span><span class="p">,</span> <span class="n">filename_schroedinger_prefix</span><span class="p">,</span>
            <span class="n">script_number_regex</span><span class="o">=</span><span class="s2">&quot;*&quot;</span><span class="p">,</span>
            <span class="n">script_extensions</span><span class="o">=</span><span class="n">script_extensions</span>
        <span class="p">)[</span><span class="n">script_extensions_index</span><span class="p">]</span>

        <span class="n">save_script</span><span class="p">(</span><span class="n">script_count_old</span><span class="p">,</span> <span class="n">input_path</span><span class="p">,</span> <span class="n">script_name</span><span class="p">,</span> <span class="n">script_args</span><span class="p">,</span> <span class="n">txt_version</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">save_script</span><span class="p">(</span><span class="n">script_count_old</span><span class="p">,</span> <span class="n">input_path</span><span class="p">,</span> <span class="n">filename_schroedinger_prefix</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="c1"># save used Schroedinger</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">System_np</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy_with_all_numpy</span><span class="p">()</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">filename_schroedinger</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">dill</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">System_np</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">filename_schroedinger</span><span class="p">),</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">dill</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>

        <span class="n">frame_end</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">frame_start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_timesteps</span>
        <span class="k">for</span> <span class="n">frame</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">frame_start</span><span class="p">,</span> <span class="n">frame_end</span><span class="p">):</span>
            <span class="n">mu_old</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu_arr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time_step</span><span class="p">(</span><span class="n">numba_used</span><span class="p">,</span> <span class="n">cupy_used</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">frame</span> <span class="o">%</span> <span class="n">steps_property</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">frame</span> <span class="o">%</span> <span class="n">steps_per_npz</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                 <span class="ow">or</span> <span class="p">(</span><span class="n">frame</span> <span class="o">==</span> <span class="n">frame_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
                <span class="c1"># calculate energy just when saving, but before creating a summary</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_E</span><span class="p">()</span>

            <span class="n">SystemSummary</span><span class="p">,</span> <span class="n">summary_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_summary</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">frame</span> <span class="o">%</span> <span class="n">steps_property</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">frame</span> <span class="o">==</span> <span class="n">frame_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">SystemSummary</span><span class="o">.</span><span class="n">monopolar</span> <span class="o">=</span> <span class="p">[[</span><span class="n">com</span><span class="o">.</span><span class="n">get</span><span class="p">()</span> <span class="k">for</span> <span class="n">com</span> <span class="ow">in</span> <span class="n">comp</span><span class="p">]</span> <span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="n">com_list</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">SystemSummary</span><span class="o">.</span><span class="n">monopolar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_center_of_mass</span><span class="p">(</span><span class="n">p</span><span class="o">=</span><span class="mf">2.0</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Problem with monopolar:</span><span class="se">\n</span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="c1"># save SchroedingerSummary not Schroedinger to save disk space</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_summary</span><span class="p">(</span><span class="n">SystemSummary</span><span class="p">,</span> <span class="n">input_path</span><span class="p">,</span> <span class="n">steps_format</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

            <span class="k">if</span> <span class="p">((</span><span class="n">frame</span> <span class="o">%</span> <span class="n">steps_per_npz</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">frame</span> <span class="o">==</span> <span class="n">frame_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># save psi_val after steps_per_npz steps of dt (to save disk space)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">save_psi_val</span><span class="p">(</span><span class="n">input_path</span><span class="p">,</span> <span class="n">filename_steps</span><span class="p">,</span> <span class="n">steps_format</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;t=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">t</span><span class="si">:</span><span class="s2">07.05f</span><span class="si">}</span><span class="s2">, mu_rel=</span><span class="si">{</span><span class="n">mu_rel</span><span class="si">}</span><span class="s2">, &quot;</span>
                      <span class="sa">f</span><span class="s2">&quot;processed=</span><span class="si">{</span><span class="p">(</span><span class="n">frame</span> <span class="o">-</span> <span class="n">frame_start</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_timesteps</span><span class="si">:</span><span class="s2">05.03f</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>

            <span class="n">mu_rel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">mu_arr</span> <span class="o">-</span> <span class="n">mu_old</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu_arr</span><span class="p">)</span>

            <span class="c1"># Stop animation when accuracy is reached</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mu_rel</span> <span class="o">&lt;</span> <span class="n">accuracy</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy reached: </span><span class="si">{</span><span class="n">mu_rel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mu_rel</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu_arr</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Accuracy NOT reached! System diverged.&quot;</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">E</span><span class="p">)),</span> <span class="p">(</span><span class="s2">&quot;E should be nan, when mu is nan.&quot;</span>
                                                  <span class="s2">&quot;Then the system is divergent.&quot;</span><span class="p">)</span>
                <span class="k">break</span>

            <span class="k">if</span> <span class="n">frame</span> <span class="o">==</span> <span class="p">(</span><span class="n">frame_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="c1"># Animation stops at the next step, to actually show the last step</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Maximum timesteps are reached. Animation is stopped.&quot;</span><span class="p">)</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Daniel Scheiermann.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>